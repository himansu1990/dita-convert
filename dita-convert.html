<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Professional DITA XML Converter</title>
<style>
body {
    font-family: 'Times New Roman', serif;
    margin: 0;
    padding: 20px;
    background: #f7f7f7;
}
h1 { font-size: 28px; color: #222; margin-bottom: 10px; border-bottom: 2px solid #ccc; padding-bottom: 5px;}
h2 { font-size: 24px; color: #333; margin-top: 20px; margin-bottom: 8px;}
h3 { font-size: 20px; color: #444; margin-top: 16px; margin-bottom: 6px;}
h4, h5 { font-size: 16px; margin-top: 14px; margin-bottom: 6px;}
p { line-height: 1.6; color: #333; margin: 6px 0;}
.note {
    display: block;
    background: #fff8d1;
    border-left: 6px solid #f4c430;
    padding: 10px;
    margin: 10px 0;
    font-style: italic;
}
.codeblock, pre {
    display: block;
    background: #272822;
    color: #f8f8f2;
    padding: 10px;
    overflow-x: auto;
    border-radius: 4px;
    font-family: monospace;
    white-space: pre-wrap;
    margin: 10px 0;
}
table {
    border-collapse: collapse;
    margin: 15px 0;
    width: 100%;
}
table, th, td {
    border: 1px solid #888;
}
th, td {
    padding: 8px 12px;
    text-align: left;
    font-size: 14px;
}
img { max-width: 100%; margin: 10px 0; }
button {
    margin-top: 10px;
    padding: 10px 15px;
    background: #4CAF50;
    color: #fff;
    border: none;
    cursor: pointer;
    border-radius: 4px;
}
button:hover { background: #45a049; }
.output-container {
    background: white;
    padding: 20px;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    width: 100%;
    box-sizing: border-box;
}

/* Live editor layout */
.editor-container {
    display: flex;
    gap: 20px;
    margin-top: 30px;
}
textarea {
    width: 50%;
    height: 400px;
    padding: 10px;
    font-family: monospace;
    font-size: 14px;
    border-radius: 4px;
    border: 1px solid #ccc;
    resize: vertical;
}
#liveOutput {
    width: 50%;
}
</style>
</head>
<body>

<h1>Professional DITA XML to HTML & PDF Converter</h1>

<input type="file" id="ditaFile" accept=".xml,.dita">
<br>
<button onclick="convertDITA()">Convert</button>
<button onclick="downloadPDF()">Download as PDF</button>
<button onclick="downloadHTML()">Download as HTML</button>

<div id="output" class="output-container" style="margin-top:20px;"></div>

<h2>Live DITA XML Editor</h2>
<div class="editor-container">
    <textarea id="ditaTextarea" placeholder="Type or paste DITA XML here..."></textarea>
    <div id="liveOutput" class="output-container"></div>
</div>
<button onclick="downloadLivePDF()">Download Live Output as PDF</button>
<button onclick="downloadLiveHTML()">Download Live Output as HTML</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script>
let renderedHTML = "";
let currentFileName = "dita-output";

function convertDITA() {
    const fileInput = document.getElementById('ditaFile');
    if (!fileInput.files.length) { alert("Please select a DITA XML file first."); return; }

    currentFileName = fileInput.files[0].name.replace(/\.[^/.]+$/, "");

    const reader = new FileReader();
    reader.onload = function(e) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(e.target.result, "application/xml");
        if (xmlDoc.getElementsByTagName("parsererror").length) { alert("Invalid XML file."); return; }
        renderedHTML = transformDITA(xmlDoc);
        document.getElementById("output").innerHTML = renderedHTML;
    };
    reader.readAsText(fileInput.files[0]);
}

function transformDITA(xmlDoc) {
    let html = "";
    const root = xmlDoc.documentElement;
    const title = root.getElementsByTagName("title")[0];
    if (title && root.tagName === "topic") html += `<h1>${title.textContent}</h1>`;

    let children = Array.from(root.children);
    if (children.length && children[0].tagName === "title") children.shift();

    html += parseDITAChildren(children, 2);
    return html;
}

function parseDITAChildren(children, headingLevel) {
    let html = "";
    for (let child of children) {
        switch (child.tagName) {
            case "title": html += `<h${headingLevel}>${child.textContent}</h${headingLevel}>`; break;
            case "p": html += `<p>${child.textContent}</p>`; break;
            case "note": html += `<div class="note">ðŸ’¡ ${child.textContent}</div>`; break;
            case "codeblock": html += `<pre class="codeblock">${child.textContent}</pre>`; break;
            case "ul": html += "<ul>" + parseDITAChildren(child.children, headingLevel) + "</ul>"; break;
            case "ol": html += "<ol>" + parseDITAChildren(child.children, headingLevel) + "</ol>"; break;
            case "li": html += `<li>${child.textContent}</li>`; break;
            case "section": html += parseDITAChildren(child.children, headingLevel); break;
            case "table": html += "<table>" + parseDITAChildren(child.children, headingLevel) + "</table>"; break;
            case "tgroup": html += parseDITAChildren(child.children, headingLevel); break;
            case "thead": html += "<thead>" + parseDITAChildren(child.children, headingLevel) + "</thead>"; break;
            case "tbody": html += "<tbody>" + parseDITAChildren(child.children, headingLevel) + "</tbody>"; break;
            case "row": html += "<tr>" + parseDITAChildren(child.children, headingLevel) + "</tr>"; break;
            case "entry": html += `<td>${child.textContent}</td>`; break;
            case "image": const href = child.getAttribute("href") || ""; html += `<img src="${href}" alt="">`; break;
            default: html += parseDITAChildren(child.children, headingLevel);
        }
    }
    return html;
}

// ------------------- PDF & HTML Download -------------------
function downloadPDF() { generatePDF("output", currentFileName + ".pdf"); }
function downloadLivePDF() { generatePDF("liveOutput", "live-dita-output.pdf"); }

function generatePDF(elementId, filename) {
    const element = document.getElementById(elementId);
    if (!element.innerHTML.trim()) { alert("No content to download."); return; }
    element.style.width = "100%";
    html2pdf().set({
        margin: [15,15,15,15],
        filename: filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    }).from(element).save().then(()=>{ element.style.width = ""; });
}

function downloadHTML() {
    if (!renderedHTML.trim()) { alert("No content to download."); return; }
    const blob = new Blob([renderedHTML], { type: "text/html" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = currentFileName + ".html";
    link.click();
}
function downloadLiveHTML() {
    const liveOutput = document.getElementById("liveOutput");
    if (!liveOutput.innerHTML.trim()) { alert("No content to download."); return; }
    const blob = new Blob([liveOutput.innerHTML], { type: "text/html" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "live-dita-output.html";
    link.click();
}

// ------------------- Live Editor -------------------
const textarea = document.getElementById("ditaTextarea");
const liveOutput = document.getElementById("liveOutput");
let liveRenderedHTML = "";

textarea.addEventListener("input", () => {
    const xmlText = textarea.value.trim();
    if (!xmlText) { liveOutput.innerHTML = ""; return; }
    try {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "application/xml");
        if (xmlDoc.getElementsByTagName("parsererror").length) {
            liveOutput.innerHTML = "<p style='color:red;'>Invalid XML</p>";
            return;
        }
        liveRenderedHTML = transformDITA(xmlDoc);
        liveOutput.innerHTML = liveRenderedHTML;
    } catch { liveOutput.innerHTML = "<p style='color:red;'>Error parsing XML</p>"; }
});
</script>
</body>
</html>
