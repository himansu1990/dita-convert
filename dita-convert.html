<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DITA Converter (Styled)</title>
<link rel="icon" href="data:,">
<style>
    body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; background: #f9f9f9; }
    .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h1, h2, h3 { color: #333; }
    p { margin-bottom: 10px; }
    note { display: block; background: #fffae6; padding: 10px; border-left: 5px solid #ffcc00; margin: 10px 0; }
    codeblock, pre { background: #eee; padding: 10px; display: block; border-radius: 5px; overflow-x: auto; }
    ul, ol { padding-left: 20px; }
    section { margin-bottom: 20px; }
    img { max-width: 100%; height: auto; margin: 10px 0; border: 1px solid #ccc; }
    button { margin: 10px 5px 10px 0; padding: 10px; cursor: pointer; }
</style>
</head>
<body>
<div class="container">
    <h1>DITA XML to HTML/PDF Converter</h1>
    <input type="file" id="xmlFile" accept=".xml"><br><br>
    <input type="file" id="assetFiles" multiple><br><br>
    <button id="generateHtml">Generate HTML</button>
    <button id="downloadHtml" disabled>Download HTML</button>
    <button id="downloadPdf" disabled>Download PDF</button>
    <div id="preview"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
<script>
const xmlInput = document.getElementById('xmlFile');
const assetsInput = document.getElementById('assetFiles');
const preview = document.getElementById('preview');
let assetMap = {};

assetsInput.addEventListener('change', () => {
    [...assetsInput.files].forEach(file => {
        const reader = new FileReader();
        reader.onload = e => assetMap[file.name] = e.target.result;
        reader.readAsDataURL(file);
    });
});

function ditaToHtml(node) {
    if (!node) return "";

    switch (node.nodeName.toLowerCase()) {
        case "title": return `<h2>${node.textContent}</h2>`;
        case "p": return `<p>${node.textContent}</p>`;
        case "note": return `<note>${node.textContent}</note>`;
        case "section": return `<section>${Array.from(node.childNodes).map(ditaToHtml).join('')}</section>`;
        case "li": return `<li>${node.textContent}</li>`;
        case "ul": return `<ul>${Array.from(node.childNodes).map(ditaToHtml).join('')}</ul>`;
        case "ol": return `<ol>${Array.from(node.childNodes).map(ditaToHtml).join('')}</ol>`;
        case "codeblock": return `<pre><code>${node.textContent}</code></pre>`;
        case "image":
            let src = node.getAttribute("href") || "";
            let fileName = src.split('/').pop();
            let imgSrc = assetMap[fileName] || src;
            return `<img src="${imgSrc}" alt="${fileName}">`;
        default:
            if (node.childNodes.length) {
                return Array.from(node.childNodes).map(ditaToHtml).join('');
            }
            return node.nodeValue || "";
    }
}

document.getElementById('generateHtml').addEventListener('click', () => {
    if (!xmlInput.files.length) {
        alert("Please upload a DITA XML file.");
        return;
    }
    const reader = new FileReader();
    reader.onload = e => {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(e.target.result, "application/xml");

        if (xmlDoc.getElementsByTagName("parsererror").length) {
            alert("Invalid XML file.");
            return;
        }

        let htmlContent = ditaToHtml(xmlDoc.documentElement);
        preview.innerHTML = htmlContent;
        document.getElementById('downloadHtml').disabled = false;
        document.getElementById('downloadPdf').disabled = false;
    };
    reader.readAsText(xmlInput.files[0]);
});

document.getElementById('downloadHtml').addEventListener('click', () => {
    const blob = new Blob([`<html><head><meta charset="UTF-8"><title>DITA Output</title></head><body>${preview.innerHTML}</body></html>`], {type: "text/html"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "dita-output.html";
    link.click();
});

document.getElementById('downloadPdf').addEventListener('click', () => {
    if (!preview.innerHTML.trim()) {
        alert("Generate HTML first.");
        return;
    }
    setTimeout(() => {
        html2pdf().from(preview).save("dita-output.pdf");
    }, 300);
});
</script>
</body>
</html>
