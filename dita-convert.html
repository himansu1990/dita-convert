<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DITA Converter</title>
<link rel="icon" href="data:,">
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #333; }
    .container { max-width: 800px; margin: auto; }
    textarea { width: 100%; height: 200px; }
    button { margin: 10px 5px 10px 0; padding: 10px; cursor: pointer; }
    #preview { border: 1px solid #ccc; padding: 10px; margin-top: 20px; }
</style>
</head>
<body>
<div class="container">
    <h1>DITA XML to HTML/PDF Converter</h1>
    <input type="file" id="xmlFile" accept=".xml"><br><br>
    <input type="file" id="assetFiles" multiple><br><br>
    <button id="generateHtml">Generate HTML</button>
    <button id="downloadHtml" disabled>Download HTML</button>
    <button id="downloadPdf" disabled>Download PDF</button>
    <div id="preview"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
<script>
const xmlInput = document.getElementById('xmlFile');
const assetsInput = document.getElementById('assetFiles');
const preview = document.getElementById('preview');
let assetMap = {};

assetsInput.addEventListener('change', () => {
    [...assetsInput.files].forEach(file => {
        const reader = new FileReader();
        reader.onload = e => assetMap[file.name] = e.target.result;
        reader.readAsDataURL(file);
    });
});

document.getElementById('generateHtml').addEventListener('click', () => {
    if (!xmlInput.files.length) {
        alert("Please upload a DITA XML file.");
        return;
    }
    const reader = new FileReader();
    reader.onload = e => {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(e.target.result, "application/xml");

        if (xmlDoc.getElementsByTagName("parsererror").length) {
            alert("Invalid XML file.");
            return;
        }

        let htmlContent = new XMLSerializer().serializeToString(xmlDoc.documentElement);
        htmlContent = htmlContent.replace(/<image[^>]+href="([^"]+)"[^>]*>/g, (match, src) => {
            const fileName = src.split('/').pop();
            if (assetMap[fileName]) {
                return `<img src="${assetMap[fileName]}" alt="${fileName}">`;
            }
            return `<img src="${src}" alt="${fileName}">`;
        });

        preview.innerHTML = htmlContent;
        document.getElementById('downloadHtml').disabled = false;
        document.getElementById('downloadPdf').disabled = false;
    };
    reader.readAsText(xmlInput.files[0]);
});

document.getElementById('downloadHtml').addEventListener('click', () => {
    const blob = new Blob([preview.innerHTML], {type: "text/html"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "dita-output.html";
    link.click();
});

document.getElementById('downloadPdf').addEventListener('click', () => {
    if (!preview.innerHTML.trim()) {
        alert("Generate HTML first.");
        return;
    }
    setTimeout(() => {
        html2pdf().from(preview).save("dita-output.pdf");
    }, 300);
});
</script>
</body>
</html>
