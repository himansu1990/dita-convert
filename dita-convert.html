<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DITA XML → HTML & PDF (Simple)</title>
  <style>
    :root{--bg:#0e1325;--panel:#141b36;--text:#e8ecff;--muted:#9aa6d1;--border:#28346b}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0e1325,#0a1022);color:var(--text);font:15px/1.5 system-ui,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:12px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    header.card{padding:14px 16px}
    h1{font-size:18px;margin:0}
    .controls{padding:12px 16px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{appearance:none;border:1px solid var(--border);background:#0f1736;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn.primary{background:#1a2c75;border-color:#2b46a8}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .badge{font-size:12px;padding:4px 10px;border:1px solid var(--border);border-radius:999px;color:var(--muted)}
    .notice{font-size:12px;color:var(--muted);padding:0 16px 12px}
    .preview{height:72vh;border-top-left-radius:14px;border-top-right-radius:14px;overflow:hidden}
    iframe{width:100%;height:100%;border:0}
    input[type=file]{display:none}
    label.file{border:1px dashed var(--border);padding:10px 14px;border-radius:10px;cursor:pointer}
  </style>
  <!-- html2pdf for PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
</head>
<body>
  <header class="card">
    <h1>DITA XML → HTML & PDF (Simple)</h1>
  </header>

  <div class="wrap">
    <section class="card">
      <div class="controls">
        <label class="file" for="xmlFile">Choose DITA .xml / .dita</label>
        <input id="xmlFile" type="file" accept=".xml,.dita" />
        <button class="btn primary" id="btnHtml" disabled>Generate HTML</button>
        <button class="btn" id="btnDownloadHtml" disabled>Download HTML</button>
        <button class="btn" id="btnPdf" disabled>Download PDF</button>
        <span class="badge" id="status">Idle</span>
      </div>
      <p class="notice">Client‑side only. Good for quick previews. For production (keys, conrefs, profiling, numbering), use DITA‑OT.</p>
    </section>

    <section class="card preview">
      <iframe id="preview" title="Preview"></iframe>
    </section>
  </div>

  <!-- Store XSLT safely inside <script type="text/xsl"> so GitHub Pages doesn't strip content -->
  <script type="text/xsl" id="xslt-basic">
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
  <xsl:output method="html" encoding="UTF-8" indent="yes"/>
  <xsl:template match="/">
    <html>
      <head>
        <meta charset="UTF-8"/>
        <title><xsl:value-of select="//title[1]"/></title>
        <style>
          body{font-family:system-ui,Segoe UI,Roboto,Inter,Arial;line-height:1.6;color:#111;margin:0}
          .page{max-width:920px;margin:0 auto;padding:28px}
          h1,h2,h3{line-height:1.25}
          h1{font-size:2rem;margin:.2em 0 .6em}
          h2{font-size:1.5rem;margin:1.2em 0 .3em}
          h3{font-size:1.2rem;margin:1em 0 .25em}
          p{margin:.5em 0}
          .shortdesc{color:#333;background:#f6f8ff;border-left:4px solid #8aa2ff;padding:.75em 1em;border-radius:6px}
          pre,code{font-family:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace}
          pre{background:#0f172a;color:#e2e8f0;padding:12px;border-radius:8px;overflow:auto}
          table{border-collapse:collapse;margin:12px 0;width:100%}
          th,td{border:1px solid #ddd;padding:8px;vertical-align:top}
          figure{margin:1em 0;text-align:center}
          figcaption{font-size:.9em;color:#555}
          @media print{.page{padding:0} a{color:#000;text-decoration:none}}
        </style>
      </head>
      <body>
        <div class="page">
          <xsl:apply-templates select="/*"/>
        </div>
      </body>
    </html>
  </xsl:template>

  <!-- Topic-like roots -->
  <xsl:template match="topic | task | concept | reference">
    <article>
      <h1><xsl:value-of select="title"/></h1>
      <xsl:if test="shortdesc"><p class="shortdesc"><xsl:apply-templates select="shortdesc/node()"/></p></xsl:if>
      <xsl:apply-templates select="body | taskbody | refbody"/>
    </article>
  </xsl:template>

  <!-- Minimal map support: render a simple TOC of hrefs/navtitles -->
  <xsl:template match="map">
    <section>
      <h1><xsl:value-of select="title"/></h1>
      <ul>
        <xsl:for-each select="topicref">
          <li>
            <xsl:choose>
              <xsl:when test="@navtitle"><xsl:value-of select="@navtitle"/></xsl:when>
              <xsl:when test="@href"><a href="{@href}"><xsl:value-of select="@href"/></a></xsl:when>
              <xsl:otherwise><em>Topic</em></xsl:otherwise>
            </xsl:choose>
          </li>
        </xsl:for-each>
      </ul>
    </section>
  </xsl:template>

  <!-- Common blocks -->
  <xsl:template match="section">
    <section>
      <h2><xsl:value-of select="title"/></h2>
      <xsl:apply-templates/>
    </section>
  </xsl:template>
  <xsl:template match="p"><p><xsl:apply-templates/></p></xsl:template>
  <xsl:template match="ul"><ul><xsl:apply-templates/></ul></xsl:template>
  <xsl:template match="ol"><ol><xsl:apply-templates/></ol></xsl:template>
  <xsl:template match="li"><li><xsl:apply-templates/></li></xsl:template>
  <xsl:template match="codeblock"><pre><xsl:apply-templates/></pre></xsl:template>
  <xsl:template match="codeph"><code><xsl:apply-templates/></code></xsl:template>
  <xsl:template match="b"><strong><xsl:apply-templates/></strong></xsl:template>
  <xsl:template match="i"><em><xsl:apply-templates/></em></xsl:template>

  <!-- Links & images -->
  <xsl:template match="xref | link">
    <xsl:choose>
      <xsl:when test="@href"><a href="{@href}"><xsl:apply-templates/></a></xsl:when>
      <xsl:otherwise><xsl:apply-templates/></xsl:otherwise>
    </xsl:choose>
  </xsl:template>
  <xsl:template match="image"><img src="{@href}" alt="{(@alt|@alt)[1]}"/></xsl:template>
  <xsl:template match="fig">
    <figure>
      <xsl:apply-templates select="image"/>
      <figcaption><xsl:value-of select="title"/></figcaption>
    </figure>
  </xsl:template>

  <!-- Tables (DITA's CALS-like) -->
  <xsl:template match="table"><table><xsl:apply-templates/></table></xsl:template>
  <xsl:template match="tgroup"><xsl:apply-templates/></xsl:template>
  <xsl:template match="thead"><thead><xsl:apply-templates/></thead></xsl:template>
  <xsl:template match="tbody"><tbody><xsl:apply-templates/></tbody></xsl:template>
  <xsl:template match="row"><tr><xsl:apply-templates/></tr></xsl:template>
  <xsl:template match="entry"><td><xsl:apply-templates/></td></xsl:template>

  <!-- Default: copy text -->
  <xsl:template match="text()|@*"><xsl:value-of select="."/></xsl:template>
</xsl:stylesheet>
  </script>

  <script>
    (function(){
      const fileInput = document.getElementById('xmlFile');
      const btnHtml = document.getElementById('btnHtml');
      const btnDownloadHtml = document.getElementById('btnDownloadHtml');
      const btnPdf = document.getElementById('btnPdf');
      const status = document.getElementById('status');
      const preview = document.getElementById('preview');

      let xmlDoc = null; // Parsed XML DOM
      let htmlDoc = null; // Transformed HTML DOM
      let xsltDoc = null; // Parsed XSLT DOM

      function setStatus(msg){ status.textContent = msg; }

      function parseXml(text){
        const p = new DOMParser();
        const doc = p.parseFromString(text, 'application/xml');
        const err = doc.querySelector('parsererror');
        if(err){ throw new Error(err.textContent.replace(/\n/g,' ')); }
        return doc;
      }

      function loadXslt(){
        if(xsltDoc) return xsltDoc;
        const raw = document.getElementById('xslt-basic').textContent;
        xsltDoc = parseXml(raw);
        return xsltDoc;
      }

      // Handle file selection
      fileInput.addEventListener('change', async (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f){ return; }
        try{
          const text = await f.text();
          xmlDoc = parseXml(text);
          setStatus('XML loaded: ' + f.name);
          btnHtml.disabled = false;
          btnDownloadHtml.disabled = true;
          btnPdf.disabled = true;
        }catch(err){
          console.error(err);
          setStatus('Failed to parse XML');
          btnHtml.disabled = true;
          btnDownloadHtml.disabled = true;
          btnPdf.disabled = true;
        }
      });

      // Transform to HTML
      btnHtml.addEventListener('click', ()=>{
        if(!xmlDoc){ return; }
        try{
          const proc = new XSLTProcessor();
          proc.importStylesheet(loadXslt());
          const doc = proc.transformToDocument(xmlDoc);
          // Ensure reasonable print margins
          const style = doc.createElement('style');
          style.textContent = '@page{margin:16mm}';
          doc.documentElement.querySelector('head')?.appendChild(style);
          htmlDoc = doc;
          const html = new XMLSerializer().serializeToString(doc);
          const blob = new Blob([html], {type:'text/html'});
          const url = URL.createObjectURL(blob);
          preview.src = url;
          btnDownloadHtml.disabled = false;
          btnPdf.disabled = false;
          setStatus('HTML generated');
        }catch(err){
          console.error(err); setStatus('Transform error');
        }
      });

      // Download HTML
      btnDownloadHtml.addEventListener('click', ()=>{
        if(!htmlDoc) return;
        const html = new XMLSerializer().serializeToString(htmlDoc);
        const blob = new Blob([html], {type:'text/html'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'output.html';
        a.click();
      });

      // Download PDF via html2pdf
      btnPdf.addEventListener('click', async ()=>{
        if(!htmlDoc) return;
        setStatus('Rendering PDF…');
        // Render hidden content
        const temp = document.createElement('div');
        temp.style.position = 'fixed';
        temp.style.left = '-9999px';
        document.body.appendChild(temp);
        temp.innerHTML = new XMLSerializer().serializeToString(htmlDoc);
        try{
          await html2pdf().from(temp).set({
            margin: 10,
            filename: 'output.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
          }).save();
          setStatus('PDF downloaded');
        }catch(err){ console.error(err); setStatus('PDF failed'); }
        finally{ document.body.removeChild(temp); }
      });

      // Ready
      setStatus('Idle');
    })();
  </script>
</body>
</html>
