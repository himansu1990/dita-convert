<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DITA Live Editor — Rich text ↔ DITA XML</title>
  <!-- Quill (Rich text) -->
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <!-- Ace (XML editor) -->
  <style>
    body { font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin:0; padding:0; height:100vh; display:flex; flex-direction:column; }
    header { padding:12px 16px; background:#f4f6f8; border-bottom:1px solid #e6e9ec; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .container { display:flex; flex:1; gap:12px; padding:12px; box-sizing:border-box; }
    .panel { flex:1; display:flex; flex-direction:column; min-width:0; }
    .panel .title { font-weight:600; margin-bottom:8px; }
    #editor { height: calc(100% - 36px); background:white; border:1px solid #ddd; border-radius:6px; overflow:auto; }
    #xmlEditor { height: calc(100% - 36px); border:1px solid #ddd; border-radius:6px; }
    .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input[type=text] { padding:8px 10px; border-radius:6px; border:1px solid #ccc; min-width:260px; }
    button.generate, button.download { background: #4CAF50; color:white; border: none; padding:10px 14px; border-radius:6px; cursor:pointer; font-weight:600; }
    button[disabled] { opacity:0.6; cursor:not-allowed; }
    .small { font-size:12px; color:#666; }
    footer { padding:8px 12px; font-size:13px; color:#666; background:#fafafa; border-top:1px solid #eee; }
    .row { display:flex; gap:12px; align-items:center; }
  </style>
</head>
<body>
  <header>
    <div style="font-weight:700">DITA Live Editor</div>
    <div class="controls">
      <input id="promptInput" type="text" placeholder="Type prompt for Gemini..." />
      <button id="generateBtn" class="generate">Generate</button>
      <button id="downloadHtmlBtn" class="download">Download HTML</button>
      <button id="downloadPdfBtn" class="download">Download PDF</button>
      <div class="small">Tip: Both editors are editable. Edits sync both ways.</div>
    </div>
  </header>

  <div class="container">
    <div class="panel">
      <div class="title">Rich Text Editor</div>
      <div id="editor"></div>
    </div>

    <div class="panel">
      <div class="title">DITA XML (editable)</div>
      <div id="xmlEditor"></div>
    </div>
  </div>

  <footer>
    <div class="row">
      <div class="small">Security note:</div>
      <div class="small">Do NOT publish your API key in client-side code on public sites. Preferred: create a small server endpoint that stores the key and proxies requests to the Gemini API.</div>
    </div>
  </footer>

  <!-- Libraries -->
  <script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.23.1/ace.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    const quill = new Quill('#editor', {
      theme: 'snow',
      modules: { toolbar: [[{ header: [1, 2, 3, false] }], ['bold','italic','underline','strike'], ['blockquote','code-block'], [{ list:'ordered'},{ list:'bullet'}], ['link','image'], ['clean']] }
    });

    const aceEditor = ace.edit('xmlEditor');
    aceEditor.session.setMode('ace/mode/xml');
    aceEditor.setTheme('ace/theme/textmate');
    aceEditor.setOptions({ fontSize: '13px', wrap: true });

    function htmlToDita(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const body = doc.body;
      const topic = document.implementation.createDocument('', '', null).createElement('topic');
      const title = document.createElement('title');
      const h1 = body.querySelector('h1,h2');
      title.textContent = h1 ? h1.textContent.trim() : 'Generated topic';
      if(h1) h1.remove();
      topic.appendChild(title);
      const shortdesc = document.createElement('shortdesc');
      const firstPara = body.querySelector('p');
      shortdesc.textContent = firstPara ? firstPara.textContent.trim() : '';
      topic.appendChild(shortdesc);
      const bodyElem = document.createElement('body');
      Array.from(body.childNodes).forEach(node => { if(node.nodeType===Node.ELEMENT_NODE){ const p=document.createElement('p'); p.textContent=node.textContent; bodyElem.appendChild(p); } });
      topic.appendChild(bodyElem);
      const serializer = new XMLSerializer();
      return '<?xml version="1.0" encoding="UTF-8"?>\n'+serializer.serializeToString(topic);
    }

    function ditaToHtml(xml) {
      try {
        const parser=new DOMParser();
        const doc=parser.parseFromString(xml,'application/xml');
        if(doc.querySelector('parsererror')) throw new Error('Parse error');
        let html='';
        if(doc.querySelector('title')) html+='<h1>'+doc.querySelector('title').textContent+'</h1>';
        if(doc.querySelector('shortdesc')) html+='<p><em>'+doc.querySelector('shortdesc').textContent+'</em></p>';
        if(doc.querySelector('body')) doc.querySelectorAll('body p').forEach(p=>html+='<p>'+p.textContent+'</p>');
        return html;
      }catch(e){return '<p><em>Invalid DITA XML</em></p>';}
    }

    let ignoreNextRich=false, ignoreNextXml=false;
    quill.on('text-change',()=>{ if(ignoreNextRich){ignoreNextRich=false;return;} const dita=htmlToDita(quill.root.innerHTML); ignoreNextXml=true; aceEditor.setValue(dita,-1); });
    let xmlChangeTimer=null;
    aceEditor.session.on('change',()=>{ if(ignoreNextXml){ignoreNextXml=false;return;} if(xmlChangeTimer) clearTimeout(xmlChangeTimer); xmlChangeTimer=setTimeout(()=>{ const html=ditaToHtml(aceEditor.getValue()); ignoreNextRich=true; quill.root.innerHTML=html; },500); });

    const sampleHtml='<h1>Sample topic</h1><p>This is a short intro.</p>';
    quill.root.innerHTML=sampleHtml;
    aceEditor.setValue(htmlToDita(sampleHtml),-1);

    // Download HTML
    document.getElementById('downloadHtmlBtn').addEventListener('click',()=>{
      const htmlContent=quill.root.innerHTML;
      const blob=new Blob([htmlContent],{type:'text/html'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='document.html';
      a.click();
    });

    // Download PDF
    document.getElementById('downloadPdfBtn').addEventListener('click',()=>{
      const { jsPDF }=window.jspdf;
      const pdf=new jsPDF();
      pdf.html(quill.root,{callback:function(doc){ doc.save('document.pdf'); }});
    });
  </script>
</body>
</html>
