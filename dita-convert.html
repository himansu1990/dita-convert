<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DITA to HTML/PDF Converter</title>

<!-- Highlight.js Oxygen-like theme -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css">

<style>
  body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
  h1, h2, h3, h4 { font-weight: bold; }
  table { border-collapse: collapse; width: 100%; margin: 15px 0; }
  table, th, td { border: 1px solid #ccc; padding: 8px; }
  img { max-width: 100%; height: auto; }
  .note {
    border-left: 5px solid #ff9800;
    background: #fff3e0;
    padding: 10px;
    margin: 15px 0;
  }
</style>
</head>
<body>

<h2>DITA to HTML/PDF Converter</h2>
<input type="file" id="ditaFile" accept=".dita,.xml"><br><br>
<button id="convertBtn">Convert to HTML</button>
<button id="downloadPdfBtn" style="display:none;">Download PDF</button>

<div id="output" style="margin-top:20px; border:1px solid #ccc; padding:10px;"></div>

<!-- Dependencies -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<script>
document.getElementById("convertBtn").addEventListener("click", function () {
    const fileInput = document.getElementById("ditaFile");
    if (!fileInput.files.length) {
        alert("Please select a DITA/XML file first.");
        return;
    }

    const file = fileInput.files[0];
    const fileNameWithoutExt = file.name.replace(/\.[^/.]+$/, "");

    const reader = new FileReader();
    reader.onload = function (e) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(e.target.result, "text/xml");

        let htmlContent = "";

        function processNode(node) {
            if (node.nodeType === Node.TEXT_NODE) {
                return node.nodeValue.trim();
            }
            if (node.nodeType !== Node.ELEMENT_NODE) return "";

            switch (node.nodeName) {
                case "title":
                    return `<h2>${node.textContent}</h2>`;
                case "section":
                    return `<section>${Array.from(node.childNodes).map(processNode).join("")}</section>`;
                case "p":
                    return `<p>${Array.from(node.childNodes).map(processNode).join("")}</p>`;
                case "note":
                    return `<div class="note">${Array.from(node.childNodes).map(processNode).join("")}</div>`;
                case "ul":
                    return `<ul>${Array.from(node.childNodes).map(processNode).join("")}</ul>`;
                case "ol":
                    return `<ol>${Array.from(node.childNodes).map(processNode).join("")}</ol>`;
                case "li":
                    return `<li>${Array.from(node.childNodes).map(processNode).join("")}</li>`;
                case "table":
                    return `<table>${Array.from(node.childNodes).map(processNode).join("")}</table>`;
                case "thead":
                    return `<thead>${Array.from(node.childNodes).map(processNode).join("")}</thead>`;
                case "tbody":
                    return `<tbody>${Array.from(node.childNodes).map(processNode).join("")}</tbody>`;
                case "tr":
                    return `<tr>${Array.from(node.childNodes).map(processNode).join("")}</tr>`;
                case "th":
                    return `<th>${node.textContent}</th>`;
                case "td":
                    return `<td>${Array.from(node.childNodes).map(processNode).join("")}</td>`;
                case "image":
                case "img":
                    const href = node.getAttribute("href") || node.getAttribute("src");
                    return href ? `<img src="${href}" alt="">` : "";
                case "codeblock":
                case "code":
                case "pre":
                    return `<pre><code>${node.textContent}</code></pre>`;
                default:
                    return Array.from(node.childNodes).map(processNode).join("");
            }
        }

        const topic = xmlDoc.documentElement;
        htmlContent = processNode(topic);

        const outputDiv = document.getElementById("output");
        outputDiv.innerHTML = htmlContent;

        // Apply syntax highlighting
        outputDiv.querySelectorAll("pre code").forEach((block) => {
            hljs.highlightElement(block);
        });

        document.getElementById("downloadPdfBtn").style.display = "inline-block";

        document.getElementById("downloadPdfBtn").onclick = function () {
            const opt = {
                margin: 0.5,
                filename: fileNameWithoutExt + ".pdf",
                image: { type: "jpeg", quality: 0.98 },
                html2canvas: { scale: 1 },
                jsPDF: { unit: "in", format: "a4", orientation: "portrait" }
            };
            html2pdf().from(outputDiv).set(opt).save();
        };
    };
    reader.readAsText(file);
});
</script>
</body>
</html>
