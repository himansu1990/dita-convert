<script>
let renderedHTML = "";
let originalFileName = ""; // Store uploaded file name

function convertDITA() {
    const fileInput = document.getElementById('ditaFile');
    if (!fileInput.files.length) {
        alert("Please select a DITA XML file first.");
        return;
    }

    // Store the file name without extension
    originalFileName = fileInput.files[0].name.replace(/\.[^/.]+$/, "");

    const reader = new FileReader();
    reader.onload = function(e) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(e.target.result, "application/xml");

        // Check for parse errors
        if (xmlDoc.getElementsByTagName("parsererror").length) {
            alert("Invalid XML file.");
            return;
        }

        // Convert XML to styled HTML
        renderedHTML = transformDITA(xmlDoc);
        document.getElementById("output").innerHTML = renderedHTML;
    };
    reader.readAsText(fileInput.files[0]);
}

function transformDITA(xmlDoc) {
    let html = "";

    // Title
    const title = xmlDoc.getElementsByTagName("title")[0];
    if (title) {
        html += `<h1>${title.textContent}</h1>`;
    }

    // Body content
    const bodyContent = xmlDoc.getElementsByTagName("body")[0];
    if (bodyContent) {
        html += parseDITAChildren(bodyContent.children);
    } else {
        html += parseDITAChildren(xmlDoc.documentElement.children);
    }

    return html;
}

function parseDITAChildren(children) {
    let html = "";
    for (let child of children) {
        switch (child.tagName) {
            case "p":
                html += `<p>${child.textContent}</p>`;
                break;
            case "note":
                html += `<note>${child.textContent}</note>`;
                break;
            case "codeblock":
                html += `<codeblock>${child.textContent}</codeblock>`;
                break;
            case "ul":
                html += "<ul>" + parseDITAChildren(child.children) + "</ul>";
                break;
            case "ol":
                html += "<ol>" + parseDITAChildren(child.children) + "</ol>";
                break;
            case "li":
                html += `<li>${child.textContent}</li>`;
                break;
            case "section":
                html += `<h2>${child.getElementsByTagName("title")[0]?.textContent || ""}</h2>`;
                html += parseDITAChildren(child.children);
                break;
            default:
                html += parseDITAChildren(child.children);
        }
    }
    return html;
}

function downloadPDF() {
    if (!renderedHTML) {
        alert("Please convert a file first.");
        return;
    }

    const element = document.getElementById("output");
    const opt = {
        margin: [10, 20, 10, 20],
        filename: `${originalFileName}.pdf`, // âœ… Use original file name
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().set(opt).from(element).save();
}
</script>
