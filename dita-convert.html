<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Rich Text Editor to DITA</title>
<style>
body { font-family: 'Times New Roman', serif; margin:0; padding:20px; background:#f7f7f7;}
h1,h2,h3,h4,h5 { color:#222; margin:10px 0;}
p { line-height:1.6; color:#333; margin:6px 0;}
.note { display:block; background:#fff8d1; border-left:6px solid #f4c430; padding:10px; margin:10px 0; font-style:italic;}
.codeblock, pre { display:block; background:#272822; color:#f8f8f2; padding:10px; overflow-x:auto; border-radius:4px; font-family:monospace; white-space:pre-wrap; margin:10px 0;}
table { border-collapse:collapse; margin:15px 0; width:100%; }
table, th, td { border:1px solid #888;}
th, td { padding:8px 12px; text-align:left; font-size:14px;}
img { max-width:100%; margin:10px 0;}
button { margin:5px 2px; padding:8px 12px; background:#4CAF50; color:#fff; border:none; cursor:pointer; border-radius:4px;}
button:hover { background:#45a049;}
.output-container { background:white; padding:20px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.2); width:100%; box-sizing:border-box; margin-top:20px;}
.editor-container { display:flex; gap:20px; margin-top:20px; align-items:stretch;}
textarea { width:50%; height:400px; padding:10px; font-family:monospace; resize:vertical;}

.ai-panel {
  background:#fff; border:1px solid #ddd; border-radius:8px; padding:12px; margin-top:12px;
  box-shadow:0 2px 6px rgba(0,0,0,0.08);
}
.ai-panel h3 { margin:6px 0 8px; }
.ai-row { display:flex; gap:8px; align-items:flex-start; }
.ai-row textarea { flex:1; height:120px; font-family:inherit; }
.ai-controls { display:flex; gap:8px; align-items:center; }
.small { font-size:12px; color:#555; }
#aiStatus { margin-left:6px; font-size:12px; color:#333; }
#aiStatus.loading::before { content:"●"; margin-right:6px; color:#4CAF50; animation: pulse 1s infinite ease-in-out; }
@keyframes pulse { 0%{opacity:.2} 50%{opacity:1} 100%{opacity:.2} }

.toolbar-badge { font-size:12px; color:#666; margin-left:8px;}
</style>
</head>
<body>

<h1>Professional DITA Studio</h1>

<!-- ---------- AI Authoring Panel (NEW) ---------- -->
<div class="ai-panel">
  <h3>AI Authoring (Gemini) → Fill the Rich Text Editor</h3>
  <div class="ai-row">
    <textarea id="aiPrompt" placeholder="Describe the document you want. Example: 
Create a concise onboarding guide for PaySecure API with H1 title, overview, prerequisites, step-by-step setup, a Note block, a code sample, and a small UL list."></textarea>
    <div class="ai-controls" style="flex-direction:column;">
      <button id="aiGenerateBtn" onclick="generateWithAI()">Generate Doc</button>
      <button id="aiAppendBtn" onclick="generateWithAI(true)" title="Append below current content">Append Doc</button>
      <span class="small">Model: gemini-1.5-pro-latest</span>
      <span id="aiStatus" class="small"></span>
    </div>
  </div>
  <div class="small">Tip: Ask for headings (H1/H2/H3), paragraphs, <code>&lt;pre&gt;</code> code, <code>&lt;div class="note"&gt;</code> notes, UL/OL lists, and optional images.</div>
</div>

<!-- ---------- Advanced Rich Text Editor ---------- -->
<h2>Rich Text Editor → Professional DITA XML <span class="toolbar-badge">(All original features intact)</span></h2>
<div class="editor-container">
  <div style="width:50%; min-width:320px;">
    <div id="toolbar" style="margin-bottom:5px;">
      <button onclick="format('h1')">H1</button>
      <button onclick="format('h2')">H2</button>
      <button onclick="format('h3')">H3</button>
      <button onclick="format('bold')">B</button>
      <button onclick="format('italic')">I</button>
      <button onclick="format('underline')">U</button>
      <button onclick="format('p')">P</button>
      <button onclick="insertNote()">Note</button>
      <button onclick="insertCode()">Code Block</button>
      <button onclick="insertImage()">Image</button>
      <button onclick="insertUL()">UL</button>
      <button onclick="insertOL()">OL</button>
    </div>
    <div id="advancedEditor" contenteditable="true" style="width:100%; height:400px; border:1px solid #ccc; padding:10px; overflow:auto; font-family:Arial;">
      <h1 data-node="title">Type Title Here</h1>
      <p data-node="p1">Type first paragraph...</p>
    </div>
  </div>
  <textarea id="advancedDITA" readonly style="width:50%; height:400px; padding:10px; font-family:monospace;"></textarea>
</div>
<button onclick="downloadAdvancedDITA()">Download Advanced DITA XML</button>

<!-- html2pdf kept (used earlier in your project) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<script>
/* =========================
   Constants / Config
========================= */
const GEMINI_API_KEY = "AIzaSyCMdJUIbMQUrkQWcKkgBn4G7fCFzpNZMJg"; // as provided
const GEMINI_ENDPOINT = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent";

/* =========================
   Existing Editor Logic
========================= */
const advEditor = document.getElementById("advancedEditor");
const advDITA = document.getElementById("advancedDITA");

function format(command){
  if(command.startsWith('h')) document.execCommand('formatBlock', false, command);
  else document.execCommand(command, false, null);
}

function insertNote(){
  const note=document.createElement('div');
  note.className='note'; note.textContent='Type note here...'; note.setAttribute('data-node','note');
  advEditor.appendChild(note); updateAdvancedDITA();
}
function insertCode(){
  const pre=document.createElement('pre');
  pre.textContent='Type code here...'; pre.setAttribute('data-node','codeblock');
  advEditor.appendChild(pre); updateAdvancedDITA();
}
function insertImage(){
  const url=prompt('Enter image URL:');
  if(url){
    fetch(url).then(r=>r.blob()).then(blob=>{
      const reader=new FileReader();
      reader.onloadend=function(){
        const img=document.createElement('img');
        img.src=reader.result; img.setAttribute('data-node','image');
        advEditor.appendChild(img); updateAdvancedDITA();
      };
      reader.readAsDataURL(blob);
    }).catch(err=>alert("Unable to load image. Make sure the URL is correct and supports CORS."));
  }
}
function insertUL(){ const ul=document.createElement('ul'); const li=document.createElement('li'); li.textContent='List item'; ul.appendChild(li); advEditor.appendChild(ul); updateAdvancedDITA(); }
function insertOL(){ const ol=document.createElement('ol'); const li=document.createElement('li'); li.textContent='List item'; ol.appendChild(li); advEditor.appendChild(ol); updateAdvancedDITA(); }

function htmlToDITA(node){
  let dita='';
  node.childNodes.forEach(child=>{
    if(child.nodeType===3 && child.textContent.trim()){
      dita+=`<p>${escapeXML(child.textContent.trim())}</p>\n`;
    } else if(child.nodeType===1){
      const tag = child.tagName.toLowerCase();
      switch(tag){
        case 'h1':
        case 'h2':
        case 'h3':
          dita+=`<title>${escapeXML(child.textContent)}</title>\n`;
          break;
        case 'p':
          dita+=`<p>${escapeXML(child.textContent)}</p>\n`;
          break;
        case 'div':
          if(child.classList.contains('note'))
            dita+=`<note>${escapeXML(child.textContent)}</note>\n`;
          else
            dita+=htmlToDITA(child);
          break;
        case 'pre':
          dita+=`<codeblock>${escapeXML(child.textContent)}</codeblock>\n`;
          break;
        case 'img':
          dita+=`<image href="${escapeAttr(child.src)}" />\n`;
          break;
        case 'ul':
          dita+="<ul>\n"+Array.from(child.children).map(li=>`<li>${escapeXML(li.textContent)}</li>`).join("\n")+"\n</ul>\n";
          break;
        case 'ol':
          dita+="<ol>\n"+Array.from(child.children).map(li=>`<li>${escapeXML(li.textContent)}</li>`).join("\n")+"\n</ol>\n";
          break;
        case 'table':
          // Optional: basic table mapping to simpletable (kept minimal)
          dita+=tableToSimpleTable(child);
          break;
        default:
          dita+=htmlToDITA(child);
      }
    }
  });
  return dita;
}

function tableToSimpleTable(tableEl){
  const rows = Array.from(tableEl.querySelectorAll('tr'));
  if(rows.length===0) return '';
  let head = '';
  let body = '';
  const firstRowTh = rows[0].querySelectorAll('th').length>0;
  rows.forEach((tr, idx)=>{
    const cells = Array.from(tr.children);
    const rowDITA = '<strow>'+cells.map(td=>{
      const tag = td.tagName.toLowerCase()==='th' ? 'sthead' : 'stentry';
      return `<${tag}>${escapeXML(td.textContent)}</${tag}>`;
    }).join('')+'</strow>';
    if(idx===0 && firstRowTh) head += rowDITA; else body += rowDITA;
  });
  let out = '<simpletable>';
  if(head) out += `<sthead>${head}</sthead>`;
  out += `<stbody>${body}</stbody></simpletable>\n`;
  return out;
}

function escapeXML(s=''){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function escapeAttr(s=''){return s.replace(/"/g,'&quot;');}

function updateAdvancedDITA(){
  advDITA.value = `<topic id="generated-topic">\n${htmlToDITA(advEditor)}\n</topic>`;
}
advEditor.addEventListener("input", updateAdvancedDITA);

function downloadAdvancedDITA(){
  const blob=new Blob([advDITA.value],{type:"text/xml"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download="advanced-dita.xml";
  link.click();
}

updateAdvancedDITA();

/* =========================
   NEW: Gemini Authoring
========================= */
async function generateWithAI(append=false){
  const btn = document.getElementById(append ? 'aiAppendBtn' : 'aiGenerateBtn');
  const statusEl = document.getElementById('aiStatus');
  const prompt = (document.getElementById('aiPrompt').value || '').trim();

  if(!prompt){
    alert('Please write a short prompt describing the document you want.');
    return;
  }

  try{
    btn.disabled = true;
    statusEl.textContent = 'Generating…';
    statusEl.classList.add('loading');

    // We instruct Gemini to return clean HTML using only the tags our editor supports.
    const systemInstructions = `
Return ONLY valid, semantic HTML fragment (no <html>, <head>, or <body> tags).
Use ONLY these elements: h1, h2, h3, p, ul, ol, li, pre, div.note, img.
- Headings: h1 for main title, h2/h3 for sections.
- Paragraphs: p.
- Lists: ul/ol with li.
- Code samples: pre (no extra indentation).
- Notes/callouts: <div class="note">…</div>.
- Images: <img src="https://…" alt="..." /> (optional; must be https and CORS-safe).
Do NOT include scripts, styles, or links. Keep output clean and professional.
`;

    const userTask = `Create a complete document based on this request:\n"${prompt}"\n` +
      `Make it ready to paste into a rich text editor.`;

    const body = {
      contents: [
        { role: "user", parts: [{ text: systemInstructions + "\n\n" + userTask }] }
      ],
      generationConfig: {
        temperature: 0.7,
        topK: 40,
        topP: 0.95,
        maxOutputTokens: 2048
      }
    };

    const res = await fetch(`${GEMINI_ENDPOINT}?key=${encodeURIComponent(GEMINI_API_KEY)}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    if(!res.ok){
      const errText = await res.text();
      throw new Error(`Gemini error (${res.status}): ${errText}`);
    }

    const data = await res.json();

    // Safely extract the first candidate text
    const candidate = data?.candidates?.[0];
    const raw = candidate?.content?.parts?.map(p => p.text || '').join('\n') || '';

    // Some models return markdown fences; strip them if present and trust our instructions were followed.
    const html = sanitizeAIHTML(raw);

    if(append){
      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      // move children to editor
      while(wrapper.firstChild){
        advEditor.appendChild(wrapper.firstChild);
      }
    } else {
      advEditor.innerHTML = html;
    }

    // After injection, update DITA view
    updateAdvancedDITA();
    statusEl.textContent = 'Done';
  } catch(err){
    console.error(err);
    alert("Failed to generate. Check console for details.\n" + err.message);
    document.getElementById('aiStatus').textContent = 'Error';
  } finally {
    btn.disabled = false;
    statusEl.classList.remove('loading');
    setTimeout(()=>{ document.getElementById('aiStatus').textContent=''; }, 1500);
  }
}

/* Minimal sanitation: remove code fences and disallowed tags, keep only the allowed set. */
function sanitizeAIHTML(input){
  let s = input.trim();

  // Remove common fenced blocks if model returned ```html ... ```
  s = s.replace(/^```(\w+)?\s*[\r\n]?/g, '').replace(/```$/g, '').trim();

  // Create a temporary container
  const tmp = document.createElement('div');
  tmp.innerHTML = s;

  // Allowed tags and note class
  const allowed = new Set(['H1','H2','H3','P','UL','OL','LI','PRE','DIV','IMG']);
  const walker = document.createTreeWalker(tmp, NodeFilter.SHOW_ELEMENT, null, false);
  const toRemove = [];

  while(walker.nextNode()){
    const el = walker.currentNode;
    if(!allowed.has(el.tagName)){
      toRemove.push(el);
      continue;
    }
    if(el.tagName==='DIV'){
      // only allow div.note
      if(!el.classList.contains('note')){
        // convert unknown divs to paragraphs
        const p = document.createElement('p');
        p.textContent = el.textContent;
        el.parentNode.replaceChild(p, el);
      }
    }
    if(el.tagName==='IMG'){
      // Basic hygiene for images
      const src = el.getAttribute('src') || '';
      if(!/^https?:\/\//i.test(src)){ el.remove(); continue; }
      el.setAttribute('data-node','image');
      el.removeAttribute('style');
      el.removeAttribute('onerror');
      el.removeAttribute('onclick');
    }
  }
  toRemove.forEach(n=>n.remove());

  // Return cleaned innerHTML
  return tmp.innerHTML;
}
</script>
</body>
</html>
