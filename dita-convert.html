<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DITA XML Converter</title>
<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background: #f7f7f7;
}
h1, h2, h3, h4, h5 {
    color: #333;
    border-bottom: 2px solid #ddd;
    padding-bottom: 4px;
}
p {
    line-height: 1.6;
    color: #444;
}
.note {
    display: block;
    background: #fff8d1;
    border-left: 6px solid #f4c430;
    padding: 10px;
    margin: 10px 0;
    font-style: italic;
}
.codeblock, pre {
    display: block;
    background: #272822;
    color: #f8f8f2;
    padding: 10px;
    overflow-x: auto;
    border-radius: 4px;
    font-family: monospace;
    white-space: pre-wrap;
}
table {
    border-collapse: collapse;
    margin: 15px 0;
    width: 100%;
    background: white;
}
table, th, td {
    border: 1px solid #ccc;
}
th, td {
    padding: 8px 12px;
    text-align: left;
}
img {
    max-width: 100%;
    margin: 10px 0;
}
button {
    margin-top: 10px;
    padding: 10px 15px;
    background: #4CAF50;
    color: #fff;
    border: none;
    cursor: pointer;
    border-radius: 4px;
}
button:hover {
    background: #45a049;
}
.output-container {
    background: white;
    padding: 20px;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
</style>
</head>
<body>

<h1>DITA XML to HTML & PDF Converter</h1>
<input type="file" id="ditaFile" accept=".xml,.dita">
<br>
<button onclick="convertDITA()">Convert</button>
<button onclick="downloadPDF()">Download as PDF</button>
<button onclick="downloadHTML()">Download as HTML</button>

<div id="output" class="output-container" style="margin-top:20px;"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script>
let renderedHTML = "";
let currentFileName = "dita-output";

function convertDITA() {
    const fileInput = document.getElementById('ditaFile');
    if (!fileInput.files.length) {
        alert("Please select a DITA XML file first.");
        return;
    }

    currentFileName = fileInput.files[0].name.replace(/\.[^/.]+$/, ""); // Remove extension

    const reader = new FileReader();
    reader.onload = function(e) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(e.target.result, "application/xml");

        if (xmlDoc.getElementsByTagName("parsererror").length) {
            alert("Invalid XML file.");
            return;
        }

        renderedHTML = transformDITA(xmlDoc);
        document.getElementById("output").innerHTML = renderedHTML;
    };
    reader.readAsText(fileInput.files[0]);
}

function transformDITA(xmlDoc) {
    let html = "";
    const root = xmlDoc.documentElement;

    // Extract and render top-level title
    const title = root.getElementsByTagName("title")[0];
    if (title && root.tagName === "topic") {
        html += `<h1>${title.textContent}</h1>`;
    }

    // Skip the first title when passing children
    let children = Array.from(root.children);
    if (children.length && children[0].tagName === "title") {
        children.shift();
    }

    html += parseDITAChildren(children, 2); // Start from h2
    return html;
}

function parseDITAChildren(children, headingLevel) {
    let html = "";
    for (let child of children) {
        switch (child.tagName) {
            case "title":
                html += `<h${headingLevel}>${child.textContent}</h${headingLevel}>`;
                break;
            case "p":
                html += `<p>${child.textContent}</p>`;
                break;
            case "note":
                html += `<div class="note">ðŸ’¡ ${child.textContent}</div>`;
                break;
            case "codeblock":
                html += `<pre class="codeblock">${child.textContent}</pre>`;
                break;
            case "ul":
                html += "<ul>" + parseDITAChildren(child.children, headingLevel) + "</ul>";
                break;
            case "ol":
                html += "<ol>" + parseDITAChildren(child.children, headingLevel) + "</ol>";
                break;
            case "li":
                html += `<li>${child.textContent}</li>`;
                break;
            case "section":
                html += parseDITAChildren(child.children, headingLevel);
                break;
            case "table":
                html += "<table>" + parseDITAChildren(child.children, headingLevel) + "</table>";
                break;
            case "tgroup":
                html += parseDITAChildren(child.children, headingLevel);
                break;
            case "thead":
                html += "<thead>" + parseDITAChildren(child.children, headingLevel) + "</thead>";
                break;
            case "tbody":
                html += "<tbody>" + parseDITAChildren(child.children, headingLevel) + "</tbody>";
                break;
            case "row":
                html += "<tr>" + parseDITAChildren(child.children, headingLevel) + "</tr>";
                break;
            case "entry":
                html += `<td>${child.textContent}</td>`;
                break;
            case "image":
                const href = child.getAttribute("href") || "";
                html += `<img src="${href}" alt="">`;
                break;
            default:
                html += parseDITAChildren(child.children, headingLevel);
        }
    }
    return html;
}

function downloadPDF() {
    if (!renderedHTML) {
        alert("Please convert a file first.");
        return;
    }
    const element = document.getElementById("output");
    const opt = {
        margin: [10, 20, 10, 20],
        filename: currentFileName + '.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(element).save();
}

function downloadHTML() {
    if (!renderedHTML) {
        alert("Please convert a file first.");
        return;
    }
    const blob = new Blob([renderedHTML], { type: "text/html" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = currentFileName + ".html";
    link.click();
}
</script>

</body>
</html>
