<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DITA XML Converter</title>
<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background: #f7f7f7;
}
h1, h2, h3, h4, h5 {
    color: #333;
    border-bottom: 2px solid #ddd;
    padding-bottom: 4px;
}
p {
    line-height: 1.6;
    color: #444;
}
note {
    display: block;
    background: #fff8d1;
    border-left: 6px solid #f4c430;
    padding: 10px;
    margin: 10px 0;
    font-style: italic;
}
codeblock, pre {
    display: block;
    background: #272822;
    color: #f8f8f2;
    padding: 10px;
    overflow-x: auto;
    border-radius: 4px;
    font-family: monospace;
    white-space: pre-wrap;
}
ul, ol {
    margin: 10px 0 10px 40px;
}
button {
    margin-top: 10px;
    padding: 10px 15px;
    background: #4CAF50;
    color: #fff;
    border: none;
    cursor: pointer;
    border-radius: 4px;
}
button:hover {
    background: #45a049;
}
.output-container {
    background: white;
    padding: 20px;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
</style>
</head>
<body>

<h1>DITA XML to HTML & PDF Converter</h1>
<input type="file" id="ditaFile" accept=".xml,.dita">
<br>
<button onclick="convertDITA()">Convert</button>
<button onclick="downloadPDF()">Download as PDF</button>

<div id="output" class="output-container" style="margin-top:20px;"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script>
let renderedHTML = "";
let originalFileName = ""; // Store uploaded file name

function convertDITA() {
    const fileInput = document.getElementById('ditaFile');
    if (!fileInput.files.length) {
        alert("Please select a DITA XML file first.");
        return;
    }

    // Store the file name without extension
    originalFileName = fileInput.files[0].name.replace(/\.[^/.]+$/, "");

    const reader = new FileReader();
    reader.onload = function(e) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(e.target.result, "application/xml");

        // Check for parse errors
        if (xmlDoc.getElementsByTagName("parsererror").length) {
            alert("Invalid XML file.");
            return;
        }

        // Convert XML to styled HTML
        renderedHTML = transformDITA(xmlDoc);
        document.getElementById("output").innerHTML = renderedHTML;
    };
    reader.readAsText(fileInput.files[0]);
}

function transformDITA(xmlDoc) {
    let html = "";

    // Title
    const title = xmlDoc.getElementsByTagName("title")[0];
    if (title) {
        html += `<h1>${title.textContent}</h1>`;
    }

    // Body content
    const bodyContent = xmlDoc.getElementsByTagName("body")[0];
    if (bodyContent) {
        html += parseDITAChildren(bodyContent.children);
    } else {
        html += parseDITAChildren(xmlDoc.documentElement.children);
    }

    return html;
}

function parseDITAChildren(children) {
    let html = "";
    for (let child of children) {
        switch (child.tagName) {
            case "p":
                html += `<p>${child.textContent}</p>`;
                break;
            case "note":
                html += `<note>${child.textContent}</note>`;
                break;
            case "codeblock":
                html += `<codeblock>${child.textContent}</codeblock>`;
                break;
            case "ul":
                html += "<ul>" + parseDITAChildren(child.children) + "</ul>";
                break;
            case "ol":
                html += "<ol>" + parseDITAChildren(child.children) + "</ol>";
                break;
            case "li":
                html += `<li>${child.textContent}</li>`;
                break;
            case "section":
                html += `<h2>${child.getElementsByTagName("title")[0]?.textContent || ""}</h2>`;
                html += parseDITAChildren(child.children);
                break;
            default:
                html += parseDITAChildren(child.children);
        }
    }
    return html;
}

function downloadPDF() {
    if (!renderedHTML) {
        alert("Please convert a file first.");
        return;
    }

    const element = document.getElementById("output");
    const opt = {
        margin: [10, 20, 10, 20],
        filename: `${originalFileName}.pdf`, // âœ… Use original file name
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().set(opt).from(element).save();
}
</script>


</body>
</html>
