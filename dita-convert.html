<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Professional DITA Studio</title>
<style>
body { font-family: 'Times New Roman', serif; margin:0; padding:20px; background:#f7f7f7;}
h1,h2,h3,h4,h5 { color:#222; margin:10px 0;}
p { line-height:1.6; color:#333; margin:6px 0;}
.note { display:block; background:#fff8d1; border-left:6px solid #f4c430; padding:10px; margin:10px 0; font-style:italic;}
.codeblock, pre { display:block; background:#272822; color:#f8f8f2; padding:10px; overflow-x:auto; border-radius:4px; font-family:monospace; white-space:pre-wrap; margin:10px 0;}
table { border-collapse:collapse; margin:15px 0; width:100%; }
table, th, td { border:1px solid #888;}
th, td { padding:8px 12px; text-align:left; font-size:14px;}
img { max-width:100%; margin:10px 0;}
button { margin:5px 2px; padding:8px 12px; background:#4CAF50; color:#fff; border:none; cursor:pointer; border-radius:4px;}
button:hover { background:#45a049;}
.output-container { background:white; padding:20px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.2); width:100%; box-sizing:border-box; margin-top:20px;}
.editor-container { display:flex; gap:20px; margin-top:20px;}
textarea { width:50%; height:400px; padding:10px; font-family:monospace; resize:vertical;}
</style>
</head>
<body>

<h1>Professional DITA Studio</h1>

<!-- ---------- File Upload Section ---------- -->
<h2>Upload DITA XML</h2>
<input type="file" id="ditaFile" accept=".xml,.dita">
<br>
<button onclick="convertDITA()">Convert</button>
<button onclick="downloadPDF('output','dita-output.pdf')">Download as PDF</button>
<button onclick="downloadHTML('output','dita-output.html')">Download as HTML</button>
<div id="output" class="output-container"></div>

<!-- ---------- Live XML Editor ---------- -->
<h2>Live DITA Editor</h2>
<div class="editor-container">
    <textarea id="ditaTextarea" placeholder="Type or paste DITA XML here..."></textarea>
    <div id="liveOutput" class="output-container"></div>
</div>
<button onclick="downloadPDF('liveOutput','live-dita-output.pdf')">Download Live Output PDF</button>
<button onclick="downloadHTML('liveOutput','live-dita-output.html')">Download Live Output HTML</button>

<!-- ---------- Advanced Rich Text Editor ---------- -->
<h2>Rich Text Editor â†’ Professional DITA XML</h2>
<div class="editor-container">
    <div style="width:50%;">
        <div id="toolbar" style="margin-bottom:5px;">
            <button onclick="format('h1')">H1</button>
            <button onclick="format('h2')">H2</button>
            <button onclick="format('h3')">H3</button>
            <button onclick="format('bold')">B</button>
            <button onclick="format('italic')">I</button>
            <button onclick="format('underline')">U</button>
            <button onclick="format('p')">P</button>
            <button onclick="insertNote()">Note</button>
            <button onclick="insertCode()">Code Block</button>
            <button onclick="insertImage()">Image</button>
            <button onclick="insertUL()">UL</button>
            <button onclick="insertOL()">OL</button>
        </div>
        <div id="advancedEditor" contenteditable="true" style="width:100%; height:400px; border:1px solid #ccc; padding:10px; overflow:auto; font-family:Arial;">
            <h1 data-node="title">Type Title Here</h1>
            <p data-node="p1">Type first paragraph...</p>
        </div>
    </div>
    <textarea id="advancedDITA" readonly style="width:50%; height:400px; padding:10px; font-family:monospace;"></textarea>
</div>
<button onclick="downloadAdvancedDITA()">Download Advanced DITA XML</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script>
// -------------------- DITA File Upload --------------------
let renderedHTML = "";
let currentFileName = "dita-output";

function convertDITA() {
    const fileInput = document.getElementById('ditaFile');
    if(!fileInput.files.length){ alert("Please select a DITA XML file first."); return; }
    currentFileName = fileInput.files[0].name.replace(/\.[^/.]+$/,"");
    const reader = new FileReader();
    reader.onload = function(e){
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(e.target.result,"application/xml");
        if(xmlDoc.getElementsByTagName("parsererror").length){ alert("Invalid XML file."); return; }
        renderedHTML = transformDITA(xmlDoc);
        document.getElementById("output").innerHTML = renderedHTML;
    };
    reader.readAsText(fileInput.files[0]);
}

function transformDITA(xmlDoc){
    let html="";
    const root = xmlDoc.documentElement;
    const title = root.getElementsByTagName("title")[0];
    if(title && root.tagName==="topic") html+=`<h1>${title.textContent}</h1>`;
    let children = Array.from(root.children);
    if(children.length && children[0].tagName==="title") children.shift();
    html+=parseDITAChildren(children,2);
    return html;
}

function parseDITAChildren(children, headingLevel){
    let html="";
    for(let child of children){
        switch(child.tagName){
            case "title": html+=`<h${headingLevel}>${child.textContent}</h${headingLevel}>`; break;
            case "p": html+=`<p>${child.textContent}</p>`; break;
            case "note": html+=`<div class="note">ðŸ’¡ ${child.textContent}</div>`; break;
            case "codeblock": html+=`<pre class="codeblock">${child.textContent}</pre>`; break;
            case "ul": html+="<ul>"+parseDITAChildren(child.children,headingLevel)+"</ul>"; break;
            case "ol": html+="<ol>"+parseDITAChildren(child.children,headingLevel)+"</ol>"; break;
            case "li": html+=`<li>${child.textContent}</li>`; break;
            case "section": html+=parseDITAChildren(child.children,headingLevel); break;
            case "table": html+="<table>"+parseDITAChildren(child.children,headingLevel)+"</table>"; break;
            case "tgroup": html+=parseDITAChildren(child.children,headingLevel); break;
            case "thead": html+="<thead>"+parseDITAChildren(child.children,headingLevel)+"</thead>"; break;
            case "tbody": html+="<tbody>"+parseDITAChildren(child.children,headingLevel)+"</tbody>"; break;
            case "row": html+="<tr>"+parseDITAChildren(child.children,headingLevel)+"</tr>"; break;
            case "entry": html+=`<td>${child.textContent}</td>`; break;
            case "image": const href=child.getAttribute("href")||""; html+=`<img src="${href}" alt="">`; break;
            default: html+=parseDITAChildren(child.children,headingLevel);
        }
    }
    return html;
}

// -------------------- PDF & HTML Download --------------------
function downloadPDF(elementId, filename){
    const element=document.getElementById(elementId);
    if(!element.innerHTML.trim()){ alert("No content to download."); return; }
    element.style.width="100%";
    html2pdf().set({
        margin:[15,15,15,15],
        filename:filename,
        image:{type:'jpeg',quality:0.98},
        html2canvas:{scale:2,useCORS:true},
        jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
    }).from(element).save().then(()=>{ element.style.width=""; });
}

function downloadHTML(elementId, filename){
    const element=document.getElementById(elementId);
    if(!element.innerHTML.trim()){ alert("No content to download."); return; }
    const blob=new Blob([element.innerHTML],{type:"text/html"});
    const link=document.createElement("a");
    link.href=URL.createObjectURL(blob);
    link.download=filename;
    link.click();
}

// -------------------- Live DITA Textarea --------------------
const textarea = document.getElementById("ditaTextarea");
const liveOutput = document.getElementById("liveOutput");
textarea.addEventListener("input",()=>{
    const xmlText = textarea.value.trim();
    if(!xmlText){ liveOutput.innerHTML=""; return; }
    try{
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText,"application/xml");
        if(xmlDoc.getElementsByTagName("parsererror").length){ liveOutput.innerHTML="<p style='color:red;'>Invalid XML</p>"; return; }
        liveOutput.innerHTML = transformDITA(xmlDoc);
    } catch{ liveOutput.innerHTML="<p style='color:red;'>Error parsing XML</p>"; }
});

// -------------------- Advanced Rich Text Editor --------------------
const advEditor=document.getElementById("advancedEditor");
const advDITA=document.getElementById("advancedDITA");

function format(command){
    if(command.startsWith('h')) document.execCommand('formatBlock',false,command);
    else document.execCommand(command,false,null);
}

function insertNote(){
    const note=document.createElement('div');
    note.className='note'; note.textContent='Type note here...'; note.setAttribute('data-node','note');
    advEditor.appendChild(note); updateAdvancedDITA();
}
function insertCode(){
    const pre=document.createElement('pre');
    pre.textContent='Type code here...'; pre.setAttribute('data-node','codeblock');
    advEditor.appendChild(pre); updateAdvancedDITA();
}
function insertImage(){
    const url=prompt('Enter image URL:');
    if(url){
        fetch(url).then(r=>r.blob()).then(blob=>{
            const reader=new FileReader();
            reader.onloadend=function(){
                const img=document.createElement('img');
                img.src=reader.result; img.setAttribute('data-node','image');
                advEditor.appendChild(img); updateAdvancedDITA();
            };
            reader.readAsDataURL(blob);
        }).catch(err=>alert("Unable to load image. Make sure the URL is correct and supports CORS."));
    }
}
function insertUL(){ const ul=document.createElement('ul'); const li=document.createElement('li'); li.textContent='List item'; ul.appendChild(li); advEditor.appendChild(ul); updateAdvancedDITA();}
function insertOL(){ const ol=document.createElement('ol'); const li=document.createElement('li'); li.textContent='List item'; ol.appendChild(li); advEditor.appendChild(ol); updateAdvancedDITA();}

function htmlToDITA(node){
    let dita=''; node.childNodes.forEach(child=>{
        if(child.nodeType===3 && child.textContent.trim()){ dita+=`<p>${child.textContent.trim()}</p>\n`; }
        else if(child.nodeType===1){
            switch(child.tagName.toLowerCase()){
                case 'h1': case 'h2': case 'h3': dita+=`<title>${child.textContent}</title>\n`; break;
                case 'p': dita+=`<p>${child.textContent}</p>\n`; break;
                case 'div': if(child.classList.contains('note')) dita+=`<note>${child.textContent}</note>\n`; else dita+=htmlToDITA(child); break;
                case 'pre': dita+=`<codeblock>${child.textContent}</codeblock>\n`; break;
                case 'img': dita+=`<image href="${child.src}" />\n`; break;
                case 'ul': dita+="<ul>\n"+Array.from(child.children).map(li=>`<li>${li.textContent}</li>`).join("\n")+"\n</ul>\n"; break;
                case 'ol': dita+="<ol>\n"+Array.from(child.children).map(li=>`<li>${li.textContent}</li>`).join("\n")+"\n</ol>\n"; break;
                default: dita+=htmlToDITA(child);
            }
        }
    });
    return dita;
}

function updateAdvancedDITA(){ advDITA.value=`<topic id="generated-topic">\n${htmlToDITA(advEditor)}\n</topic>`;}
advEditor.addEventListener("input", updateAdvancedDITA);

function downloadAdvancedDITA(){
    const blob=new Blob([advDITA.value],{type:"text/xml"});
    const link=document.createElement("a");
    link.href=URL.createObjectURL(blob);
    link.download="advanced-dita.xml";
    link.click();
}

updateAdvancedDITA();
</script>
</body>
</html>
