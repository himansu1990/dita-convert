<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live DITA Editor Free + Gemini AI</title>
  <style>
    body { font-family: 'Times New Roman', serif; margin:0; padding:20px; background:#f7f7f7;}
    h1,h2,h3,h4,h5 { color:#222; margin:10px 0;}
    p { line-height:1.6; color:#333; margin:6px 0;}
    .note { display:block; background:#fff8d1; border-left:6px solid #f4c430; padding:10px; margin:10px 0; font-style:italic;}
    .codeblock, pre { display:block; background:#272822; color:#f8f8f2; padding:10px; overflow-x:auto; border-radius:4px; font-family:monospace; white-space:pre-wrap; margin:10px 0;}
    table { border-collapse:collapse; margin:15px 0; width:100%; }
    table, th, td { border:1px solid #888;}
    th, td { padding:8px 12px; text-align:left; font-size:14px;}
    img { max-width:100%; margin:10px 0;}
    button { margin:5px 2px; padding:8px 12px; background:#4CAF50; color:#fff; border:none; cursor:pointer; border-radius:4px;}
    button:hover { background:#45a049;}
    .output-container { background:white; padding:20px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.2); width:100%; box-sizing:border-box; margin-top:20px;}
    .editor-container { display:flex; gap:20px; margin-top:20px;}
    textarea { width:50%; height:400px; padding:10px; font-family:monospace; resize:vertical;}
    #promptBox { width:60%; padding:8px; margin-top:10px; }
    .edit-mode { border:2px dashed #f4c430; padding:15px; }
  </style>
</head>
<body>
  <!-- ---------- Live XML Editor ---------- -->
  <h2>Live DITA Editor (with Gemini AI)</h2>

  <!-- AI Prompt Input -->
  <div>
    <input type="text" id="promptBox" placeholder="Type a prompt to generate DITA XML..." />
    <button onclick="generateXML()">Generate XML</button>
  </div>

  <div class="editor-container">
    <textarea id="ditaTextarea" placeholder="Type or paste DITA XML here..."></textarea>
    <div id="liveOutput" class="output-container"></div>
  </div>

  <!-- Action Buttons -->
  <button onclick="toggleEdit()">Enable Editing</button>
  <button onclick="downloadPDF('liveOutput')">Download Live Output PDF</button>
  <button onclick="downloadHTML('liveOutput')">Download Live Output HTML</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <script>
    // -------------------- Helper: Get Safe Filename --------------------
    function getSafeFilename(prompt, extension){
      let name = prompt || "live-dita-output";
      name = name.replace(/[<>:"/\\|?*]+/g, "").trim(); // remove invalid filename chars
      if(!name) name = "live-dita-output";
      return name + extension;
    }

    // -------------------- DITA Transform --------------------
    function transformDITA(xmlDoc){
      let html="";
      const root = xmlDoc.documentElement;
      const title = root.getElementsByTagName("title")[0];
      if(title && root.tagName==="topic"){
        html+=`<h1>${title.textContent}</h1>`;
      } else {
        const prompt = document.getElementById("promptBox").value.trim();
        if(prompt) html+=`<h1>${prompt}</h1>`;
      }
      let children = Array.from(root.children);
      if(children.length && children[0].tagName==="title") children.shift();
      html+=parseDITAChildren(children,2);
      return html;
    }

    function parseDITAChildren(children, headingLevel){
      let html="";
      for(let child of children){
        switch(child.tagName){
          case "title": html+=`<h${headingLevel}>${child.textContent}</h${headingLevel}>`; break;
          case "p": html+=`<p>${child.textContent}</p>`; break;
          case "note": html+=`<div class="note">💡 ${child.textContent}</div>`; break;
          case "codeblock": html+=`<pre class="codeblock">${child.textContent}</pre>`; break;
          case "ul": html+="<ul>"+parseDITAChildren(child.children,headingLevel)+"</ul>"; break;
          case "ol": html+="<ol>"+parseDITAChildren(child.children,headingLevel)+"</ol>"; break;
          case "li": html+=`<li>${child.textContent}</li>`; break;
          case "section": html+=parseDITAChildren(child.children,headingLevel); break;
          case "table": html+="<table>"+parseDITAChildren(child.children,headingLevel)+"</table>"; break;
          case "tgroup": html+=parseDITAChildren(child.children,headingLevel); break;
          case "thead": html+="<thead>"+parseDITAChildren(child.children,headingLevel)+"</thead>"; break;
          case "tbody": html+="<tbody>"+parseDITAChildren(child.children,headingLevel)+"</tbody>"; break;
          case "row": html+="<tr>"+parseDITAChildren(child.children,headingLevel)+"</tr>"; break;
          case "entry": html+=`<td>${child.textContent}</td>`; break;
          case "image": const href=child.getAttribute("href")||""; html+=`<img src="${href}" alt="">`; break;
          default: html+=parseDITAChildren(child.children,headingLevel);
        }
      }
      return html;
    }

    // -------------------- PDF & HTML Download --------------------
    function downloadPDF(elementId){
      const element=document.getElementById(elementId);
      if(!element.innerHTML.trim()){
        alert("No content to download.");
        return;
      }
      const prompt = document.getElementById("promptBox").value.trim();
      const filename = getSafeFilename(prompt,".pdf");
      element.style.width="100%";
      html2pdf().set({
        margin:[15,15,15,15],
        filename:filename,
        image:{type:'jpeg',quality:0.98},
        html2canvas:{scale:2,useCORS:true},
        jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
      }).from(element).save().then(()=>{
        element.style.width="";
      });
    }

    function downloadHTML(elementId){
      const element=document.getElementById(elementId);
      if(!element.innerHTML.trim()){
        alert("No content to download.");
        return;
      }
      const prompt = document.getElementById("promptBox").value.trim();
      const filename = getSafeFilename(prompt,".html");
      const blob=new Blob([element.innerHTML],{type:"text/html"});
      const link=document.createElement("a");
      link.href=URL.createObjectURL(blob);
      link.download=filename;
      link.click();
    }

    // -------------------- Live DITA Preview --------------------
    const textarea = document.getElementById("ditaTextarea");
    const liveOutput = document.getElementById("liveOutput");

    textarea.addEventListener("input",()=>{
      const xmlText = textarea.value.trim();
      if(!xmlText){ liveOutput.innerHTML=""; return; }
      try{
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText,"application/xml");
        if(xmlDoc.getElementsByTagName("parsererror").length){
          liveOutput.innerHTML="<p style='color:red;'>Invalid XML</p>";
          return;
        }
        liveOutput.innerHTML = transformDITA(xmlDoc);
      } catch{
        liveOutput.innerHTML="<p style='color:red;'>Error parsing XML</p>";
      }
    });

    // -------------------- Gemini AI Integration --------------------
    async function generateXML(){
      const prompt=document.getElementById("promptBox").value.trim();
      if(!prompt){ alert("Please enter a prompt."); return; }
      try {
        const apiKey = "AIzaSyCMdJUIbMQUrkQWcKkgBn4G7fCFzpNZMJg"; // ⚠️ Replace with your key
        const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key="+apiKey, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{ role: "user", parts: [{ text: `Generate a valid DITA XML topic. Prompt: ${prompt}` }] }]
          })
        });
        const data = await response.json();
        if(data.candidates && data.candidates.length > 0){
          const generatedXML = data.candidates[0].content.parts[0].text;
          textarea.value = generatedXML;
          textarea.dispatchEvent(new Event("input")); // refresh preview
        } else {
          alert("No output from Gemini.");
        }
      } catch (err) {
        console.error(err);
        alert("Error generating XML from Gemini API.");
      }
    }

    // ✅ New Feature: Toggle Editable Mode
    let isEditable = false;
    function toggleEdit(){
      isEditable = !isEditable;
      liveOutput.contentEditable = isEditable;
      if(isEditable){
        liveOutput.classList.add("edit-mode");
        alert("Edit Mode Enabled: You can now modify the output directly before downloading.");
      } else {
        liveOutput.classList.remove("edit-mode");
        alert("Edit Mode Disabled: Output is back to preview-only.");
      }
    }

    // ✅ New Feature: Trigger Gemini when pressing Enter
    document.getElementById("promptBox").addEventListener("keydown", function(event) {
      if(event.key === "Enter"){
        event.preventDefault();
        generateXML();
      }
    });
  </script>
</body>
</html>
