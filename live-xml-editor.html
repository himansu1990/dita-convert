<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live DITA Editor (Strict Lists + Gemini)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#f7f7f7; --card:#fff; --ink:#222; --muted:#666;
      --brand:#4CAF50; --border:#e5e5e5; --code:#272822; --code-ink:#f8f8f2;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Arial,Helvetica,sans-serif}
    header{padding:16px 20px}
    h1,h2,h3{margin:.5rem 0}
    .row{display:flex;gap:18px;align-items:stretch;padding:0 20px 20px}
    textarea{width:48%;height:600px;padding:12px;border:1px solid var(--border);border-radius:8px;background:var(--card);font-family:ui-monospace,SFMono-Regular,Menlo,monospace;line-height:1.45}
    .panel{width:52%;display:flex;flex-direction:column;border:1px solid var(--border);border-radius:8px;background:var(--card);overflow:hidden}
    .panel-header{padding:12px 14px;border-bottom:1px solid var(--border);font-weight:600;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .toolbar{padding:8px 10px;border-bottom:1px solid var(--border);display:flex;gap:6px;flex-wrap:wrap;background:#fafafa}
    .toolbar button,.toolbar select,.toolbar input[type=color]{
      border:1px solid #ddd;background:#fff;border-radius:6px;padding:6px 10px;cursor:pointer;font-size:13px
    }
    .toolbar button:hover{background:#f1f1f1}
    #rte{padding:16px;flex:1 1 auto;overflow:auto;outline:none;min-height:320px}
    #rte.edit{outline:2px dashed #f4c430;outline-offset:6px}
    .controls{padding:10px;border-top:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap;background:#fafafa}
    .btn{background:var(--brand);color:#fff;border:none;border-radius:6px;padding:8px 12px;cursor:pointer}
    .btn.secondary{background:#2d7ef7}
    .btn.gray{background:#888}
    .btn:hover{opacity:.95}
    pre.codeblock{background:var(--code);color:var(--code-ink);padding:10px;border-radius:6px;white-space:pre-wrap}
    table{border-collapse:collapse;width:100%;margin:10px 0}
    th,td{border:1px solid #888;padding:8px 10px;text-align:left}
    .muted{color:var(--muted);font-size:12px}
    input[type=text]{padding:8px 10px;border:1px solid var(--border);border-radius:6px;min-width:280px}
  </style>
</head>
<body>
  <header>
    <h2>Live DITA Editor (Strict Lists + Gemini)</h2>
    <div class="muted">Two-way sync: Rich text ‚áÜ DITA topic XML (Oxygen-compatible). Lists round-trip with <code>&lt;li&gt;&lt;p&gt;‚Ä¶&lt;/p&gt;&lt;/li&gt;</code>.</div>
  </header>

  <div class="row">
    <!-- Left: XML editor -->
    <textarea id="xmlBox" placeholder="Paste or edit a DITA topic here‚Ä¶&#10;It will render on the right."></textarea>

    <!-- Right: Rich editor -->
    <div class="panel">
      <div class="panel-header">
        <span>Rich Editor</span>
        <input id="prompt" type="text" placeholder="Prompt for Gemini to generate DITA topic‚Ä¶" />
        <button class="btn secondary" id="genBtn">Generate XML (Gemini)</button>
      </div>

      <div class="toolbar" id="toolbar">
        <button onclick="cmd('bold')"><b>B</b></button>
        <button onclick="cmd('italic')"><i>I</i></button>
        <button onclick="cmd('underline')"><u>U</u></button>
        <button onclick="cmd('insertUnorderedList')">‚Ä¢ List</button>
        <button onclick="cmd('insertOrderedList')">1. List</button>
        <button onclick="formatBlock('p')">P</button>
        <button onclick="formatBlock('h1')">H1</button>
        <button onclick="formatBlock('h2')">H2</button>
        <button onclick="formatBlock('h3')">H3</button>
        <button onclick="createLink()">üîó Link</button>
        <button onclick="unlink()">Unlink</button>
        <button onclick="insertImage()">üñºÔ∏è Image</button>
        <button onclick="insertTable()">üìä Table</button>
        <button onclick="insertCodeBlock()">üíª Code</button>
        <button onclick="syncNow()">üîÅ Sync Now (HTML ‚Üí DITA)</button>
      </div>

      <div id="rte" contenteditable="true">
        <h1>Getting Started</h1>
        <p>Type here. Press Enter to create proper &lt;p&gt; blocks.</p>
        <ul>
          <li>Example bullet</li>
        </ul>
      </div>

      <div class="controls">
        <button id="toggleBtn" class="btn">Disable Editing</button>
        <button class="btn gray" onclick="downloadHTML()">Download Rich HTML</button>
        <button class="btn gray" onclick="downloadPDF()">Download Rich PDF</button>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <script>
    // ‚ö†Ô∏è Included per your request. Do NOT ship in production with a public key.
    const GEMINI_API_KEY = "AIzaSyCMdJUIbMQUrkQWcKkgBn4G7fCFzpNZMJg";

    const xmlBox = document.getElementById('xmlBox');
    const rte = document.getElementById('rte');
    const toggleBtn = document.getElementById('toggleBtn');
    const genBtn = document.getElementById('genBtn');
    const promptInput = document.getElementById('prompt');

    // Ensure Enter inserts <p>
    try { document.execCommand('defaultParagraphSeparator', false, 'p'); } catch(e){}

    // ---------- Toolbar helpers ----------
    function cmd(name, value=null){ document.execCommand(name, false, value); rte.focus(); onRteInput(); }
    function formatBlock(tag){ document.execCommand('formatBlock', false, tag.toUpperCase()); rte.focus(); onRteInput(); }
    function createLink(){ const url = prompt('Enter URL (https://‚Ä¶)'); if(url) cmd('createLink', url); }
    function unlink(){ cmd('unlink'); }
    function insertImage(){ const u = prompt('Image URL'); if(u) cmd('insertImage', u); }

    function insertTable(){
      const rows = Math.max(1, parseInt(prompt('Rows (incl. header)?', '3'))||3);
      const cols = Math.max(1, parseInt(prompt('Columns?', '3'))||3);
      const withHeader = confirm('Use first row as header?');
      let html = '<table><tbody>';
      for(let r=0;r<rows;r++){
        html += '<tr>';
        for(let c=0;c<cols;c++){
          html += (withHeader && r===0) ? `<th>Header ${c+1}</th>` : '<td>Cell</td>';
        }
        html += '</tr>';
      }
      html += '</tbody></table><p><br></p>'; // trailing paragraph to escape table
      document.execCommand('insertHTML', false, html);
      placeCaretAtEnd(rte);
      onRteInput();
    }
    function insertCodeBlock(){
      const code = prompt('Enter code:');
      if(code!==null){
        document.execCommand('insertHTML', false, `<pre class="codeblock">${escapeHTML(code)}</pre><p><br></p>`);
        placeCaretAtEnd(rte);
        onRteInput();
      }
    }
    function placeCaretAtEnd(el){
      el.focus();
      const range = document.createRange();
      range.selectNodeContents(el);
      range.collapse(false);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
    }

    // ---------- Escape helpers ----------
    function escapeHTML(s){return (s||'').replace(/[&<>]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]));}
    function xmlEscape(s){return (s||'').replace(/[&<>]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]));}
    function xmlAttr(s){return xmlEscape(String(s).replace(/"/g,'&quot;'));}

    // ---------- HTML ‚Üí DITA (strict, with <li><p> wrapper) ----------
    function htmlToDITA(rootEl){
      const titleText = (rootEl.querySelector('h1')?.textContent || 'Untitled').trim();
      const lines = [];
      lines.push(`<?xml version="1.0" encoding="UTF-8"?>`);
      lines.push(`<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">`);
      lines.push(`<topic id="topic_${Date.now()}">`);
      lines.push(`<title>${xmlEscape(titleText)}</title>`);
      lines.push(`<body>`);

      const nodes = Array.from(rootEl.childNodes);
      let i = 0;
      // skip the first h1 if present
      if(nodes[0] && nodes[0].nodeType===1 && nodes[0].tagName.toLowerCase()==='h1') i=1;

      while(i<nodes.length){
        const n = nodes[i];
        lines.push(convertBlock(n));
        i++;
      }

      lines.push(`</body>`);
      lines.push(`</topic>`);
      return lines.join('\n');
    }

    function convertBlock(el){
      if(el.nodeType===3){
        const t = el.textContent.trim();
        return t ? `<p>${xmlEscape(t)}</p>` : '';
      }
      if(el.nodeType!==1) return '';

      const tag = el.tagName.toLowerCase();
      switch(tag){
        case 'p': return `<p>${inlineToDITA(el)}</p>`;
        case 'pre': return `<codeblock>${xmlEscape(el.textContent)}</codeblock>`;
        case 'ul': return listToDITA(el, 'ul');
        case 'ol': return listToDITA(el, 'ol');
        case 'img': return `<image href="${xmlAttr(el.getAttribute('src')||'')}"/>`;
        case 'table': return tableToDITA(el);
        case 'h2':
        case 'h3': {
          const title = el.textContent.trim();
          // collect until next heading
          let xml = `<section>\n<title>${xmlEscape(title)}</title>\n`;
          let sib = el.nextSibling;
          while(sib && !(sib.nodeType===1 && /^h[1-3]$/i.test(sib.tagName))){
            xml += convertBlock(sib);
            sib = sib.nextSibling;
          }
          xml += `</section>`;
          return xml;
        }
        case 'div':
        case 'span':
          if(el.childNodes.length) return Array.from(el.childNodes).map(convertBlock).join('');
          return '';
        default:
          if(/^h[1-6]$/.test(tag)) return ''; // h1 already used as title
          return el.textContent.trim() ? `<p>${xmlEscape(el.textContent.trim())}</p>` : '';
      }
    }

    function inlineToDITA(el){
      let out = '';
      for(const n of el.childNodes){
        if(n.nodeType===3){ out += xmlEscape(n.textContent); continue; }
        if(n.nodeType!==1) continue;
        const t = n.tagName.toLowerCase();
        switch(t){
          case 'b':
          case 'strong': out += `<b>${inlineToDITA(n)}</b>`; break;
          case 'i':
          case 'em': out += `<i>${inlineToDITA(n)}</i>`; break;
          case 'u': out += `<u>${inlineToDITA(n)}</u>`; break;
          case 'code': out += `<codeph>${xmlEscape(n.textContent)}</codeph>`; break;
          case 'kbd': out += `<uicontrol>${xmlEscape(n.textContent)}</uicontrol>`; break;
          case 'a': {
            const href = n.getAttribute('href')||'';
            out += `<xref href="${xmlAttr(href)}">${xmlEscape(n.textContent||href)}</xref>`; break;
          }
          case 'img': out += `<image href="${xmlAttr(n.getAttribute('src')||'')}"/>`; break;
          default: out += xmlEscape(n.textContent);
        }
      }
      return out;
    }

    function listToDITA(listEl, kind){ // kind: 'ul' or 'ol'
      const items = Array.from(listEl.querySelectorAll(':scope > li')).map(li=>{
        const inner = `<p>${inlineToDITA(li)}</p>`; // auto-wrap
        return `<li>${inner}</li>`;
      }).join('');
      return `<${kind}>${items}</${kind}>`;
    }

    function tableToDITA(tbl){
      const rows = Array.from(tbl.querySelectorAll(':scope > tbody > tr, :scope > tr'));
      const headerRow = rows.find(r => r.querySelector('th'));
      const colCount = Math.max(1, ...rows.map(r=>r.querySelectorAll('td,th').length));
      let xml = `<table><tgroup cols="${colCount}">`;
      if(headerRow){
        xml += `<thead><row>`;
        headerRow.querySelectorAll('th,td').forEach(c=>{ xml += `<entry>${inlineToDITA(c)}</entry>`; });
        xml += `</row></thead>`;
      }
      xml += `<tbody>`;
      rows.forEach(r=>{
        if(r===headerRow) return;
        xml += `<row>`;
        r.querySelectorAll('td,th').forEach(c=>{ xml += `<entry>${inlineToDITA(c)}</entry>`; });
        xml += `</row>`;
      });
      xml += `</tbody></tgroup></table>`;
      return xml;
    }

    // ---------- DITA ‚Üí HTML (back-conversion, list-aware) ----------
    function ditaToHTML(xmlText){
      try{
        const doc = new DOMParser().parseFromString(xmlText, 'application/xml');
        if(doc.getElementsByTagName('parsererror').length) return `<p style="color:red">Invalid XML</p>`;
        const topic = doc.documentElement;
        if(!topic || topic.tagName!=='topic') return `<p style="color:red">Root must be &lt;topic&gt;</p>`;

        let html = '';
        const title = topic.getElementsByTagName('title')[0];
        if(title) html += `<h1>${escapeHTML(title.textContent)}</h1>`;

        const body = topic.getElementsByTagName('body')[0] || topic;
        html += renderBody(Array.from(body.childNodes), 2);
        return html;
      }catch(e){
        return `<p style="color:red">Parse error</p>`;
      }
    }

    function renderBody(nodes, level){
      let out = '';
      for(const n of nodes){
        if(n.nodeType===3){ const t = n.textContent.trim(); if(t) out += `<p>${escapeHTML(t)}</p>`; continue; }
        if(n.nodeType!==1) continue;
        switch(n.tagName){
          case 'p': out += `<p>${renderInline(n)}</p>`; break;
          case 'section': {
            const t = n.getElementsByTagName('title')[0];
            if(t) out += `<h${Math.min(6,level)}>${escapeHTML(t.textContent)}</h${Math.min(6,level)}>`;
            const inner = Array.from(n.childNodes).filter(x=>!(x.nodeType===1 && x.tagName==='title'));
            out += renderBody(inner, Math.min(6,level+1));
            break;
          }
          case 'ul': out += renderList(n, 'ul'); break;
          case 'ol': out += renderList(n, 'ol'); break;
          case 'codeblock': out += `<pre class="codeblock">${escapeHTML(n.textContent)}</pre>`; break;
          case 'image': {
            const href = n.getAttribute('href')||''; out += `<img src="${href}" alt="">`; break;
          }
          case 'table': out += renderTable(n); break;
          default:
            // unknown -> paragraph fallback
            out += `<p>${escapeHTML(n.textContent)}</p>`;
        }
      }
      return out;
    }

    function renderList(listEl, kind){
      const lis = Array.from(listEl.getElementsByTagName('li'));
      const items = lis.map(li=>{
        // If <li><p>‚Ä¶</p></li> use inner <p> inline; else use all inline
        const p = li.getElementsByTagName('p')[0];
        const content = p ? renderInline(p) : renderInline(li);
        return `<li>${content}</li>`;
      }).join('');
      return `<${kind}>${items}</${kind}>`;
    }

    function renderTable(tableEl){
      const tg = tableEl.getElementsByTagName('tgroup')[0];
      let theadRows=[], tbodyRows=[];
      if(tg){
        const thead = tg.getElementsByTagName('thead')[0];
        const tbody = tg.getElementsByTagName('tbody')[0] || tg;
        if(thead) theadRows = Array.from(thead.getElementsByTagName('row'));
        if(tbody) tbodyRows = Array.from(tbody.getElementsByTagName('row'));
      }
      const rowToHTML = row => `<tr>${Array.from(row.children).filter(c=>c.tagName==='entry').map(c=>`<td>${renderInline(c)}</td>`).join('')}</tr>`;
      const theadHTML = theadRows.length ? `<thead>${theadRows.map(rowToHTML).join('')}</thead>` : '';
      const tbodyHTML = `<tbody>${tbodyRows.map(rowToHTML).join('')}</tbody>`;
      return `<table>${theadHTML}${tbodyHTML}</table>`;
    }

    function renderInline(el){
      let out = '';
      for(const node of el.childNodes){
        if(node.nodeType===3){ out += escapeHTML(node.textContent); continue; }
        if(node.nodeType!==1) continue;
        switch(node.tagName){
          case 'b': out += `<b>${renderInline(node)}</b>`; break;
          case 'i': out += `<i>${renderInline(node)}</i>`; break;
          case 'u': out += `<u>${renderInline(node)}</u>`; break;
          case 'codeph': out += `<code>${escapeHTML(node.textContent)}</code>`; break;
          case 'xref': {
            const href = node.getAttribute('href')||''; out += `<a href="${href}">${escapeHTML(node.textContent||href)}</a>`; break;
          }
          default: out += escapeHTML(node.textContent);
        }
      }
      return out;
    }

    // ---------- Sync wiring ----------
    function onXmlInput(){
      const xml = xmlBox.value.trim();
      if(!xml){ rte.innerHTML = '<h1>Untitled</h1>'; return; }
      rte.innerHTML = ditaToHTML(xml);
    }
    function onRteInput(){
      xmlBox.value = htmlToDITA(rte);
    }
    function syncNow(){ onRteInput(); }

    xmlBox.addEventListener('input', onXmlInput);
    rte.addEventListener('input', onRteInput);

    // Enable/disable editing
    let editable = true;
    function toggleEdit(){
      editable = !editable;
      rte.contentEditable = String(editable);
      rte.classList.toggle('edit', editable);
      toggleBtn.textContent = editable ? 'Disable Editing' : 'Enable Editing';
    }
    toggleBtn.addEventListener('click', toggleEdit);

    // ---------- Downloads ----------
    function downloadHTML(){
      const blob = new Blob([rte.innerHTML],{type:'text/html'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'rich.html';
      a.click();
    }
    function downloadPDF(){
      if(!rte.innerHTML.trim()){ alert('Nothing to export'); return; }
      html2pdf().set({
        margin:[15,15,15,15],
        filename:'rich.pdf',
        image:{type:'jpeg',quality:0.98},
        html2canvas:{scale:2,useCORS:true},
        jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
      }).from(rte).save();
    }

    // ---------- Gemini generator ----------
    async function generateWithGemini(){
      const prompt = promptInput.value.trim();
      if(!prompt){ alert('Enter a prompt'); return; }
      try{
        const res = await fetch(
          'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+GEMINI_API_KEY,
          {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
              contents:[{role:'user',parts:[{text:
                `Generate a valid DITA topic with <!DOCTYPE topic ...>. Include <topic><title><body>. Use <p>, <ul>/<ol> with <li><p>‚Ä¶</p></li>, <codeblock>, and a simple <table><tgroup><tbody> form. Topic about: ${prompt}`
              }]}]
            })
          }
        );
        const data = await res.json();
        const xml = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
        if(!xml){ alert('No output from Gemini'); return; }
        xmlBox.value = xml.trim();
        onXmlInput();
      }catch(e){
        console.error(e);
        alert('Gemini error');
      }
    }
    genBtn.addEventListener('click', generateWithGemini);
    promptInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); generateWithGemini(); }});

    // ---------- Init ----------
    // Start with RTE ‚Üí XML so left shows a valid topic shell
    window.addEventListener('load', ()=>{
      rte.classList.add('edit');
      onRteInput(); // populate xmlBox from initial rich content
    });
  </script>
</body>
</html>
