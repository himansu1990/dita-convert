<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DITA Editor with Gemini AI</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:20px; background:#f7f7f7;}
    h1 { color:#333; }
    textarea { width:100%; height:200px; margin-top:10px; }
    #ditaContent { border:1px solid #ccc; min-height:200px; background:#fff; padding:10px; overflow:auto; }
    .toolbar { display:none; margin:10px 0; gap:5px; }
    .toolbar button { padding:6px 12px; border:none; background:#333; color:#fff; border-radius:5px; cursor:pointer; }
    .toolbar button:hover { background:#555; }
    .edit-mode { border:2px solid #007bff; }
    #promptBox { width:100%; padding:8px; }
  </style>
</head>
<body>
  <h1>DITA Live Editor + Gemini AI</h1>

  <label>Enter Prompt for Gemini AI:</label>
  <textarea id="promptBox" placeholder="Type your prompt here..."></textarea>
  <button onclick="generateXML()">Generate DITA from AI</button>

  <h3>Generated DITA XML:</h3>
  <textarea id="ditaTextarea" placeholder="Generated DITA XML will appear here"></textarea>

  <button onclick="toggleEdit()" id="editBtn">Enable Editing</button>
  <div class="toolbar" id="toolbar">
    <button onclick="execCmd('bold')">Bold</button>
    <button onclick="execCmd('italic')">Italic</button>
    <button onclick="execCmd('underline')">Underline</button>
    <button onclick="wrapSelection('h1')">H1</button>
    <button onclick="wrapSelection('h2')">H2</button>
    <button onclick="insertTable()">Table</button>
    <button onclick="insertCodeBlock()">Code</button>
    <button onclick="createLink()">Link</button>
    <button onclick="insertImage()">Image</button>
  </div>

  <h3>Live DITA Content:</h3>
  <div id="ditaContent" contenteditable="false"></div>

  <button onclick="downloadHTML()">Download HTML</button>
  <button onclick="downloadPDF()">Download PDF</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    const apiKey = "AIzaSyCMdJUIbMQUrkQWcKkgBn4G7fCFzpNZMJg"; // ⚠️ Replace with your Gemini API key
    const ditaTextarea = document.getElementById("ditaTextarea");
    const ditaContent = document.getElementById("ditaContent");

    async function generateXML(){
      const prompt = document.getElementById("promptBox").value;
      if(!prompt.trim()) return alert("Enter a prompt first!");
      
      try {
        const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key="+apiKey, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{ parts: [{ text: `Write valid DITA XML for: ${prompt}` }]}]
          })
        });
        const data = await response.json();
        const xml = data.candidates[0].content.parts[0].text;
        ditaTextarea.value = xml;
        ditaContent.innerHTML = xml;
      } catch(e){
        alert("Error generating XML: " + e);
      }
    }

    // Two-way binding: textarea → editor
    ditaTextarea.addEventListener("input", () => {
      ditaContent.innerHTML = ditaTextarea.value;
    });

    // Two-way binding: editor → textarea
    ditaContent.addEventListener("input", () => {
      ditaTextarea.value = ditaContent.innerHTML;
    });

    function toggleEdit(){
      const toolbar = document.getElementById("toolbar");
      const editBtn = document.getElementById("editBtn");
      if(ditaContent.isContentEditable){
        ditaContent.contentEditable = false;
        ditaContent.classList.remove("edit-mode");
        toolbar.style.display = "none";
        editBtn.textContent = "Enable Editing";
      } else {
        ditaContent.contentEditable = true;
        ditaContent.classList.add("edit-mode");
        toolbar.style.display = "flex";
        editBtn.textContent = "Disable Editing";
      }
    }

    function execCmd(command, value=null){
      document.execCommand(command, false, value);
      ditaContent.focus();
    }
    function createLink(){ const url = prompt("Enter URL:"); if(url) execCmd("createLink", url); }
    function insertImage(){ const url = prompt("Image URL:"); if(url) execCmd("insertImage", url); }
    function wrapSelection(tag){ document.execCommand('formatBlock', false, tag.toUpperCase()); }
    function insertTable(){
      const rows = prompt("Rows?",2); const cols = prompt("Cols?",2);
      let table = "<table border='1'>";
      for(let r=0;r<rows;r++){ table += "<tr>"; for(let c=0;c<cols;c++){ table += "<td>Cell</td>"; } table += "</tr>"; }
      table += "</table>";
      document.execCommand("insertHTML", false, table);
    }
    function insertCodeBlock(){ const code = prompt("Enter code:"); if(code) document.execCommand("insertHTML", false, `<pre>${code}</pre>`); }

    async function downloadPDF(){
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      const content = ditaContent;
      const canvas = await html2canvas(content);
      const imgData = canvas.toDataURL("image/png");
      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
      pdf.save("dita-output.pdf");
    }

    function downloadHTML(){
      const blob = new Blob([ditaContent.innerHTML], {type: "text/html"});
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "dita-output.html";
      link.click();
    }
  </script>
</body>
</html>
