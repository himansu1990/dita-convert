<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live DITA Editor Free + Gemini AI</title>
  <style>
    body { font-family: 'Times New Roman', serif; margin:0; padding:20px; background:#f7f7f7;}
    h1,h2,h3,h4,h5 { color:#222; margin:10px 0;}
    p { line-height:1.6; color:#333; margin:6px 0;}
    .note { display:block; background:#fff8d1; border-left:6px solid #f4c430; padding:10px; margin:10px 0; font-style:italic;}
    .codeblock, pre { display:block; background:#272822; color:#f8f8f2; padding:10px; overflow-x:auto; border-radius:4px; font-family:monospace; white-space:pre-wrap; margin:10px 0;}
    table { border-collapse:collapse; margin:15px 0; width:100%; }
    table, th, td { border:1px solid #888;}
    th, td { padding:8px 12px; text-align:left; font-size:14px;}
    img { max-width:100%; margin:10px 0;}
    button { margin:5px 2px; padding:8px 12px; background:#4CAF50; color:#fff; border:none; cursor:pointer; border-radius:4px;}
    button:hover { background:#45a049;}

    .editor-container { display:flex; gap:20px; margin-top:20px; align-items:stretch;}
    textarea { width:50%; height:500px; padding:10px; font-family:monospace; resize:vertical; }

    /* Output panel with sticky header, toolbar, and sticky action bar */
    .output-container {
      background:white; padding:0; border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
      width:50%; box-sizing:border-box; margin-top:20px;
      display:flex; flex-direction:column;
      max-height:500px; overflow:hidden; position:relative;
      border:1px solid #e5e5e5;
    }
    .output-header { padding:12px 16px; border-bottom:1px solid #eee; font-weight:bold; position:sticky; top:0; background:#fff; z-index:12; }

    /* Toolbar (shown only in edit mode) */
    .toolbar {
      display:none;
      background:#f8f8f8;
      border-bottom:1px solid #e5e5e5;
      padding:6px 10px;
      position:sticky; top:44px; z-index:11;
      gap:6px; flex-wrap:wrap;
    }
    .toolbar button, .toolbar select, .toolbar input[type=color] {
      padding:6px 10px; margin:2px; font-size:13px; border-radius:6px; border:1px solid #ddd; background:#fff; cursor:pointer;
    }
    .toolbar button:hover { background:#f0f0f0; }
    .toolbar-group { display:inline-flex; align-items:center; gap:4px; margin-right:8px; }

    #ditaContent { padding:20px; overflow:auto; flex:1 1 auto; }
    .edit-mode { outline:2px dashed #f4c430; outline-offset:6px; }

    /* Sticky buttons inside the output box */
    .button-container {
      position:sticky; bottom:0; z-index:10;
      background:#fafafa; border-top:1px solid #e5e5e5;
      padding:10px 16px;
      display:flex; gap:8px; flex-wrap:wrap;
    }

    #promptBox { width:60%; padding:8px; margin-top:10px; }

    .ql-toolbar button {
  background: #f1f1f1 !important;   /* light gray background */
  border: 1px solid #ccc !important;
  border-radius: 4px;
  margin: 2px;
  transition: background 0.2s ease;
}

.ql-toolbar button:hover {
  background: #ddd !important;       /* darker on hover */
}

.ql-toolbar button.ql-active {
  background: #4CAF50 !important;    /* green when active */
  color: white !important;
}

  </style>
</head>
<body>
  <!-- ---------- Live XML Editor ---------- -->
  <h2>Live DITA Editor (with Gemini AI)</h2>

  <!-- AI Prompt Input -->
  <div>
    <input type="text" id="promptBox" placeholder="Type a prompt to generate DITA XML..." />
    <button onclick="generateXML()">Generate XML</button>
  </div>

  <div class="editor-container">
    <!-- Source XML -->
    <textarea id="ditaTextarea" placeholder="Type or paste DITA XML here..."></textarea>

    <!-- Output container with sticky header, toolbar, and sticky buttons -->
    <div id="liveOutput" class="output-container">
      <div class="output-header">Live Output</div>

      <!-- Rich Text Toolbar (visible only when editing) -->
      <div class="toolbar" id="toolbar">
        <div class="toolbar-group">
          <button onclick="execCmd('bold')"><b>B</b></button>
          <button onclick="execCmd('italic')"><i>I</i></button>
          <button onclick="execCmd('underline')"><u>U</u></button>
          <button onclick="execCmd('strikeThrough')">S</button>
        </div>
        <div class="toolbar-group">
          <button onclick="execCmd('justifyLeft')">‚ü∏</button>
          <button onclick="execCmd('justifyCenter')">‚áî</button>
          <button onclick="execCmd('justifyRight')">‚üπ</button>
        </div>
        <div class="toolbar-group">
          <button onclick="execCmd('insertUnorderedList')">‚Ä¢ List</button>
          <button onclick="execCmd('insertOrderedList')">1. List</button>
          <button onclick="execCmd('outdent')">Outdent</button>
          <button onclick="execCmd('indent')">Indent</button>
        </div>
        <div class="toolbar-group">
          <button onclick="wrapSelection('h1')">H1</button>
          <button onclick="wrapSelection('h2')">H2</button>
          <button onclick="wrapSelection('h3')">H3</button>
          <button onclick="wrapSelection('p')">P</button>
        </div>
        <div class="toolbar-group">
          <button onclick="createLink()">üîó Link</button>
          <button onclick="execCmd('unlink')">Unlink</button>
          <button onclick="insertImage()">üñºÔ∏è Image</button>
        </div>
        <div class="toolbar-group">
          <label>Font</label>
          <select onchange="execCmd('fontName', this.value)">
            <option value="Times New Roman">Times</option>
            <option value="Arial">Arial</option>
            <option value="Courier New">Courier</option>
            <option value="Georgia">Georgia</option>
            <option value="Verdana">Verdana</option>
          </select>
          <label>Size</label>
          <select onchange="execCmd('fontSize', this.value)">
            <option value="1">Small</option>
            <option value="3" selected>Normal</option>
            <option value="5">Large</option>
            <option value="7">Huge</option>
          </select>
          <label>Color</label>
          <input type="color" onchange="execCmd('foreColor', this.value)">
          <button onclick="execCmd('removeFormat')">Clear</button>
        </div>
      </div>

      <!-- Rendered DITA goes here -->
      <div id="ditaContent"></div>

      <!-- Sticky Action Buttons -->
      <div class="button-container">
        <button id="editBtn" onclick="toggleEdit()">Enable Editing</button>
        <button onclick="downloadPDF('ditaContent')">Download Live Output PDF</button>
        <button onclick="downloadHTML('ditaContent')">Download Live Output HTML</button>
      </div>
    </div>
  </div>

  <!-- html2pdf for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <script>
    // -------------------- Helper: Get Safe Filename --------------------
    function getSafeFilename(prompt, extension){
      let name = prompt || "live-dita-output";
      name = name.replace(/[<>:"/\\|?*]+/g, "").trim(); // remove invalid filename chars
      if(!name) name = "live-dita-output";
      return name + extension;
    }

    // -------------------- DITA Transform --------------------
    function transformDITA(xmlDoc){
      let html="";
      const root = xmlDoc.documentElement;
      const title = root.getElementsByTagName("title")[0];

      if(title && root.tagName==="topic"){
        html+=`<h1>${title.textContent}</h1>`;
      } else {
        // fallback: use the prompt as title if no <title> in XML
        const prompt = document.getElementById("promptBox").value.trim();
        if(prompt) html+=`<h1>${prompt}</h1>`;
      }

      let children = Array.from(root.children);
      if(children.length && children[0].tagName==="title") children.shift();
      html+=parseDITAChildren(children,2);
      return html;
    }

    function parseDITAChildren(children, headingLevel){
      let html="";
      for(let child of children){
        switch(child.tagName){
          case "title": html+=`<h${headingLevel}>${child.textContent}</h${headingLevel}>`; break;
          case "p": html+=`<p>${child.textContent}</p>`; break;
          case "note": html+=`<div class="note">üí° ${child.textContent}</div>`; break;
          case "codeblock": html+=`<pre class="codeblock">${child.textContent}</pre>`; break;
          case "ul": html+="<ul>"+parseDITAChildren(child.children,headingLevel)+"</ul>"; break;
          case "ol": html+="<ol>"+parseDITAChildren(child.children,headingLevel)+"</ol>"; break;
          case "li": html+=`<li>${child.textContent}</li>`; break;
          case "section": html+=parseDITAChildren(child.children,headingLevel); break;
          case "table": html+="<table>"+parseDITAChildren(child.children,headingLevel)+"</table>"; break;
          case "tgroup": html+=parseDITAChildren(child.children,headingLevel); break;
          case "thead": html+="<thead>"+parseDITAChildren(child.children,headingLevel)+"</thead>"; break;
          case "tbody": html+="<tbody>"+parseDITAChildren(child.children,headingLevel)+"</tbody>"; break;
          case "row": html+="<tr>"+parseDITAChildren(child.children,headingLevel)+"</tr>"; break;
          case "entry": html+=`<td>${child.textContent}</td>`; break;
          case "image": {
            const href=child.getAttribute("href")||"";
            html+=`<img src="${href}" alt="">`;
            break;
          }
          default: html+=parseDITAChildren(child.children,headingLevel);
        }
      }
      return html;
    }

    // -------------------- PDF & HTML Download --------------------
    function downloadPDF(elementId){
      const element=document.getElementById(elementId);
      if(!element.innerHTML.trim()){
        alert("No content to download.");
        return;
      }
      const prompt = document.getElementById("promptBox").value.trim();
      const filename = getSafeFilename(prompt,".pdf");
      const origWidth = element.style.width;
      element.style.width="100%";
      html2pdf().set({
        margin:[15,15,15,15],
        filename:filename,
        image:{type:'jpeg',quality:0.98},
        html2canvas:{scale:2,useCORS:true},
        jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
      }).from(element).save().then(()=>{
        element.style.width = origWidth || "";
      });
    }

    function downloadHTML(elementId){
      const element=document.getElementById(elementId);
      if(!element.innerHTML.trim()){
        alert("No content to download.");
        return;
      }
      const prompt = document.getElementById("promptBox").value.trim();
      const filename = getSafeFilename(prompt,".html");
      const blob=new Blob([element.innerHTML],{type:"text/html"});
      const link=document.createElement("a");
      link.href=URL.createObjectURL(blob);
      link.download=filename;
      link.click();
    }

    // -------------------- Live DITA Preview --------------------
    const textarea = document.getElementById("ditaTextarea");
    const ditaContent = document.getElementById("ditaContent");

    textarea.addEventListener("input",()=>{
      const xmlText = textarea.value.trim();
      if(!xmlText){ ditaContent.innerHTML=""; return; }
      try{
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText,"application/xml");
        if(xmlDoc.getElementsByTagName("parsererror").length){
          ditaContent.innerHTML="<p style='color:red;'>Invalid XML</p>";
          return;
        }
        ditaContent.innerHTML = transformDITA(xmlDoc);
      } catch{
        ditaContent.innerHTML="<p style='color:red;'>Error parsing XML</p>";
      }
    });

    // -------------------- Gemini AI Integration --------------------
    async function generateXML(){
      const prompt=document.getElementById("promptBox").value.trim();
      if(!prompt){ alert("Please enter a prompt."); return; }
      try {
        const apiKey = "AIzaSyCMdJUIbMQUrkQWcKkgBn4G7fCFzpNZMJg"; // ‚ö†Ô∏è Replace with your Gemini API key
        const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key="+apiKey, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{ role: "user", parts: [{ text: `Generate a valid DITA XML topic. Prompt: ${prompt}` }] }]
          })
        });
        const data = await response.json();
        if(data.candidates && data.candidates.length > 0){
          const generatedXML = data.candidates[0].content.parts[0].text;
          textarea.value = generatedXML;
          textarea.dispatchEvent(new Event("input")); // refresh preview
        } else {
          alert("No output from Gemini.");
        }
      } catch (err) {
        console.error(err);
        alert("Error generating XML from Gemini API.");
      }
    }

    // ‚úÖ Toggle Editable Mode with Dynamic Button Text + toolbar visibility
    let isEditable = false;
    function toggleEdit(){
      isEditable = !isEditable;
      const editBtn = document.getElementById("editBtn");
      ditaContent.contentEditable = isEditable;
      const toolbar = document.getElementById("toolbar");
      if(isEditable){
        ditaContent.classList.add("edit-mode");
        editBtn.textContent = "Disable Editing";
        toolbar.style.display = "flex";
        // Place caret inside content for convenience
        focusEnd(ditaContent);
      } else {
        ditaContent.classList.remove("edit-mode");
        editBtn.textContent = "Enable Editing";
        toolbar.style.display = "none";
      }
    }

    // Editor commands
    function execCmd(command, value=null){
      document.execCommand(command, false, value);
      ditaContent.focus();
    }

    function createLink(){
      const url = prompt("Enter the URL (include https://):");
      if(url) execCmd("createLink", url);
    }

    function insertImage(){
      const url = prompt("Enter image URL:");
      if(url) execCmd("insertImage", url);
    }

    // Wrap selection with block element (e.g., H1/H2/P)
    function wrapSelection(tag){
      // Using execCommand 'formatBlock' for block level elements
      document.execCommand('formatBlock', false, tag.toUpperCase());
      ditaContent.focus();
    }

    // Put caret at end of contentEditable
    function focusEnd(el){
      el.focus();
      const range = document.createRange();
      range.selectNodeContents(el);
      range.collapse(false);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
    }

    // ‚úÖ Trigger Gemini when pressing Enter in prompt box
    document.getElementById("promptBox").addEventListener("keydown", function(event) {
      if(event.key === "Enter"){
        event.preventDefault();
        generateXML();
      }
    });
  </script>
</body>
</html>
