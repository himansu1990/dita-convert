<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Live DITA Editor + Gemini + Quill (Tables & Code)</title>

  <!-- Quill styles -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

  <!-- quill-better-table styles -->
  <link href="https://cdn.jsdelivr.net/npm/quill-better-table@1.2.10/dist/quill-better-table.min.css" rel="stylesheet">

  <style>
    :root {
      --panel-bg: #ffffff;
      --primary: #2d9c2f;
      --muted: #777;
    }
    body {
      font-family: 'Segoe UI', Roboto, "Times New Roman", serif;
      margin: 0;
      padding: 18px;
      background: #f4f6f8;
      color: #111;
    }
    h1 { margin: 0 0 12px 0; font-size:20px; color:#222; }
    .layout {
      display: flex;
      gap: 18px;
      align-items: flex-start;
    }

    /* left pane: DITA xml */
    .left {
      width: 48%;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    textarea#ditaTextarea {
      width:100%;
      height:560px;
      padding:10px;
      font-family: monospace;
      font-size:13px;
      border-radius:6px;
      border:1px solid #ddd;
      box-sizing:border-box;
      resize:vertical;
    }

    .prompt-row { display:flex; gap:8px; align-items:center; }
    input#promptBox {
      width: 70%;
      padding:8px;
      border-radius:6px;
      border:1px solid #ddd;
      box-sizing:border-box;
    }
    button.primary {
      background: var(--primary);
      color:white;
      border:none;
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
    }
    button.primary:hover { filter:brightness(.95); }

    /* right pane: editor & toolbar */
    .right {
      width: 52%;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .output-panel {
      background: var(--panel-bg);
      border-radius:8px;
      border:1px solid #e6e9ec;
      box-shadow: 0 6px 18px rgba(20,30,40,0.03);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      height:650px;
    }
    .output-header {
      padding:12px 14px;
      border-bottom:1px solid #eee;
      font-weight:600;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      background:linear-gradient(0deg, rgba(255,255,255,0.7), rgba(255,255,255,0.7));
      position:sticky;
      top:0;
      z-index:20;
    }

    /* toolbar area (shown only in edit mode) */
    .toolbar-wrap {
      display:none; /* toggled by JS */
      border-bottom:1px solid #eee;
      background: #fafafa;
      padding:8px 10px;
      z-index:15;
    }
    .toolbar-wrap .ql-formats button,
    .toolbar-wrap .ql-formats select {
      background:#fff;
      border:1px solid #ddd;
      border-radius:6px;
      padding:6px 8px;
      margin:2px;
      cursor:pointer;
      color:#000;
    }
    .toolbar-wrap .ql-formats button:hover { background:#f0f0f0; }

    /* editor container (Quill) */
    #editor {
      flex:1;
      height:100%;
      overflow:auto;
      background: white;
    }

    /* sticky action bar at bottom inside panel */
    .action-bar {
      position: sticky;
      bottom: 0;
      background: #fbfbfb;
      border-top: 1px solid #eee;
      padding: 10px;
      display:flex;
      gap:8px;
      align-items:center;
      z-index:30;
    }
    .muted { color: var(--muted); font-size:13px; }

    /* small helpers */
    .small { font-size:13px; color:#333; }
    .btn-ghost {
      background: white;
      border:1px solid #ddd;
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
    }
    .btn-danger {
      background:#c0392b; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;
    }

    /* code block styling matches earlier CSS */
    pre.codeblock {
      display:block;
      background:#272822;
      color:#f8f8f2;
      padding:10px;
      overflow-x:auto;
      border-radius:4px;
      font-family:monospace;
      white-space:pre-wrap;
      margin:10px 0;
    }

    /* make table bordered nicely inside editor */
    .ql-editor table {
      border-collapse: collapse;
      width:100%;
    }
    .ql-editor table td, .ql-editor table th {
      border:1px solid #ccc;
      padding:6px 8px;
    }

    /* responsive */
    @media (max-width: 1000px) {
      .layout { flex-direction:column; }
      .left, .right { width:100%; }
      .output-panel { height:520px; }
      textarea#ditaTextarea { height:360px; }
    }
  </style>
</head>
<body>
  <h1>Live DITA Editor ‚Äî Rich Editing, Tables & Code Blocks</h1>

  <div class="layout">
    <!-- LEFT: DITA XML + Gemini prompt -->
    <div class="left">
      <div class="prompt-row">
        <input id="promptBox" placeholder="Type prompt to generate DITA XML (press Enter)..." />
        <button class="primary" id="genBtn">Generate XML (Gemini)</button>
        <button class="btn-ghost" id="loadToEditorBtn" title="Render XML into the editor">Render ‚Üí Editor</button>
      </div>

      <textarea id="ditaTextarea" placeholder="Type or paste DITA XML here..."></textarea>
      <div class="small muted">Tip: edit XML or generate using Gemini, then click <b>Render ‚Üí Editor</b> to turn DITA into editable HTML.</div>
    </div>

    <!-- RIGHT: Quill editor (Live Output) -->
    <div class="right">
      <div class="output-panel">
        <div class="output-header">
          <div>Live Output (Quill Rich Editor)</div>
          <div class="muted small">Toggle editing to show/hide toolbar & table controls</div>
        </div>

        <!-- Toolbar (Quill + extra buttons). Hidden unless editing is enabled -->
        <div class="toolbar-wrap" id="toolbarWrap">
          <!-- Quill standard toolbar groups (we'll wire these by class names) -->
          <span class="ql-formats">
            <button class="ql-bold" title="Bold"></button>
            <button class="ql-italic" title="Italic"></button>
            <button class="ql-underline" title="Underline"></button>
            <button class="ql-strike" title="Strike"></button>
          </span>

          <span class="ql-formats">
            <select class="ql-font"></select>
            <select class="ql-size"></select>
            <select class="ql-color"></select>
          </span>

          <span class="ql-formats">
            <button class="ql-list" value="ordered" title="Ordered list"></button>
            <button class="ql-list" value="bullet" title="Bullet list"></button>
            <button class="ql-indent" value="-1" title="Outdent"></button>
            <button class="ql-indent" value="+1" title="Indent"></button>
          </span>

          <span class="ql-formats">
            <button class="ql-align" value="" title="Align left"></button>
            <button class="ql-align" value="center" title="Center"></button>
            <button class="ql-align" value="right" title="Right"></button>
          </span>

          <span class="ql-formats">
            <button class="ql-link" title="Insert link"></button>
            <button class="ql-image" title="Insert image"></button>
            <button class="ql-code-block" title="Code block"></button>
          </span>

          <!-- Our extra table controls -->
          <span class="ql-formats">
            <button id="insertTableBtn" title="Insert table (3x3)">üìä Insert Table</button>
            <button id="deleteTableBtn" title="Delete entire table at cursor">üóëÔ∏è Delete Table</button>
          </span>

          <span class="ql-formats">
            <button id="h1Btn">H1</button>
            <button id="h2Btn">H2</button>
            <button id="h3Btn">H3</button>
          </span>
        </div>

        <!-- Quill editor element -->
        <div id="editor"></div>

        <!-- Sticky action bar -->
        <div class="action-bar">
          <button id="toggleEditBtn" class="primary">Enable Editing</button>
          <button id="downloadPdfBtn" class="btn-ghost">Download PDF</button>
          <button id="downloadHtmlBtn" class="btn-ghost">Download HTML</button>
          <div style="flex:1"></div>
          <div class="muted">Editor powered by Quill + quill-better-table</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quill & plugins -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quill-better-table@1.2.10/dist/quill-better-table.min.js"></script>

  <!-- html2pdf for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <script>
    /*************************************************************************
     *  CONFIG
     *  Replace GEMINI_API_KEY with your key if you insist on client-side use.
     *  WARNING: Putting API keys in client-side code is public and insecure.
     *  Prefer creating a simple backend endpoint that holds the key securely.
     *************************************************************************/
    const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY"; // <<< REPLACE if you want client-side testing

    /*************************************************************************
     *  Register and initialize Quill with quill-better-table
     *************************************************************************/
    Quill.register({
      'modules/better-table': QuillBetterTable
    }, true);

    const quill = new Quill('#editor', {
      theme: 'snow',
      modules: {
        toolbar: '#toolbarWrap',     // use our toolbarWrap element
        table: false,
        'better-table': {
          operationMenu: {
            items: {
              unmergeCells: { text: 'Unmerge cells' },
              insertRowAbove: { text: 'Insert row above' },
              insertRowBelow: { text: 'Insert row below' },
              insertColumnLeft: { text: 'Insert column left' },
              insertColumnRight: { text: 'Insert column right' },
              deleteRow: { text: 'Delete row' },
              deleteColumn: { text: 'Delete column' }
            }
          }
        },
        keyboard: {
          bindings: QuillBetterTable.keyboardBindings
        }
      }
    });

    // Initially disable editing (we will enable via toggle).
    quill.disable();
    document.getElementById('toolbarWrap').style.display = 'none';

    /*************************************************************************
     * Utility: find table container blot at current selection (if any)
     * Returns the blot or null.
     *************************************************************************/
    function findTableAtSelection() {
      const range = quill.getSelection();
      if (!range) return null;
      const [blot, ] = quill.getLeaf(range.index);
      if (!blot) return null;

      // Walk up to find container blot of table
      let node = blot;
      while (node) {
        if (node.statics && (node.statics.blotName === 'table' || node.statics.blotName === 'table-container')) {
          return node;
        }
        node = node.parent;
      }
      return null;
    }

    /*************************************************************************
     * Insert Table (default 3x3) ‚Äî uses better-table module
     *************************************************************************/
    document.getElementById('insertTableBtn').addEventListener('click', function() {
      const tableModule = quill.getModule('better-table');
      if (!tableModule) {
        alert('Table module not available.');
        return;
      }
      // prompt for size (safe fallback defaults)
      let rows = parseInt(prompt('Enter rows:', '3'), 10);
      let cols = parseInt(prompt('Enter columns:', '3'), 10);
      if (!(rows > 0)) rows = 3;
      if (!(cols > 0)) cols = 3;
      tableModule.insertTable(rows, cols);
    });

    /*************************************************************************
     * Delete entire table at cursor
     *************************************************************************/
    document.getElementById('deleteTableBtn').addEventListener('click', function() {
      const range = quill.getSelection();
      if (!range) { alert('Place cursor inside the table to delete it.'); return; }

      // walk to find table-container blot via scroll.descendant
      let tableBlot = null;
      quill.scroll.descendants(function(blot) {
        // find first table-container that contains current index
        return (blot.statics && blot.statics.blotName === 'table-container');
      }).forEach(function(blot) {
        // check if selection index is inside blot's index range
        // blot.offset will give its index; blot.length() its length
        // But easier: check node.contains selection DOM node
        const sel = window.getSelection();
        if (!sel.rangeCount) return;
        const selNode = sel.anchorNode;
        if (!selNode) return;
        const blotNode = blot.domNode || blot.node;
        if (blotNode && blotNode.contains(selNode)) tableBlot = blot;
      });

      if (!tableBlot) {
        // fallback: try findTableAtSelection
        const found = findTableAtSelection();
        tableBlot = found ? found : null;
      }

      if (tableBlot) {
        // remove blot from DOM
        tableBlot.remove();
      } else {
        alert('No table found at cursor. Place the cursor inside the table first.');
      }
    });

    /*************************************************************************
     * Headings buttons (H1/H2/H3)
     *************************************************************************/
    document.getElementById('h1Btn').addEventListener('click', ()=> quill.format('header', 1));
    document.getElementById('h2Btn').addEventListener('click', ()=> quill.format('header', 2));
    document.getElementById('h3Btn').addEventListener('click', ()=> quill.format('header', 3));

    /*************************************************************************
     * Toggle editing: enable/disable Quill & show/hide toolbar
     *************************************************************************/
    const toggleEditBtn = document.getElementById('toggleEditBtn');
    toggleEditBtn.addEventListener('click', () => {
      const toolbarWrap = document.getElementById('toolbarWrap');
      if (quill.isEnabled()) {
        quill.disable();
        toolbarWrap.style.display = 'none';
        toggleEditBtn.textContent = 'Enable Editing';
      } else {
        quill.enable();
        toolbarWrap.style.display = 'block';
        toggleEditBtn.textContent = 'Disable Editing';
      }
    });

    /*************************************************************************
     * Downloaders
     *************************************************************************/
    document.getElementById('downloadHtmlBtn').addEventListener('click', () => {
      const html = quill.root.innerHTML;
      const filename = (document.getElementById('promptBox').value || 'live-dita-output') + '.html';
      const blob = new Blob([html], { type: 'text/html' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename.replace(/[<>:"/\\|?*]+/g, '');
      a.click();
    });

    document.getElementById('downloadPdfBtn').addEventListener('click', () => {
      const element = quill.root;
      const filename = (document.getElementById('promptBox').value || 'live-dita-output') + '.pdf';
      html2pdf().set({
        margin:[15,15,15,15],
        filename: filename.replace(/[<>:"/\\|?*]+/g, ''),
        image:{type:'jpeg',quality:0.98},
        html2canvas:{scale:2,useCORS:true},
        jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
      }).from(element).save();
    });

    /*************************************************************************
     * DITA ‚Üí HTML rendering: transform DITA XML to simple HTML using earlier logic,
     * then set into Quill (as HTML).
     *************************************************************************/
    function transformDITA(xmlDoc) {
      let html = '';
      const root = xmlDoc.documentElement;
      const title = root.getElementsByTagName('title')[0];
      if (title && root.tagName === 'topic') {
        html += `<h1>${escapeHtml(title.textContent)}</h1>`;
      } else {
        const prompt = document.getElementById('promptBox').value.trim();
        if (prompt) html += `<h1>${escapeHtml(prompt)}</h1>`;
      }

      let children = Array.from(root.children);
      if (children.length && children[0].tagName === 'title') children.shift();
      html += parseDITAChildren(children, 2);
      return html;
    }

    function parseDITAChildren(children, headingLevel) {
      let html = '';
      for (let child of children) {
        const tag = child.tagName;
        switch (tag) {
          case 'title': html += `<h${headingLevel}>${escapeHtml(child.textContent)}</h${headingLevel}>`; break;
          case 'p': html += `<p>${escapeHtml(child.textContent)}</p>`; break;
          case 'note': html += `<div class="note">üí° ${escapeHtml(child.textContent)}</div>`; break;
          case 'codeblock': html += `<pre class="codeblock">${escapeHtml(child.textContent)}</pre>`; break;
          case 'ul': html += `<ul>${parseDITAChildren(child.children, headingLevel)}</ul>`; break;
          case 'ol': html += `<ol>${parseDITAChildren(child.children, headingLevel)}</ol>`; break;
          case 'li': html += `<li>${escapeHtml(child.textContent)}</li>`; break;
          case 'section': html += parseDITAChildren(child.children, headingLevel); break;
          case 'table': html += `<table>${parseDITAChildren(child.children, headingLevel)}</table>`; break;
          case 'tgroup': html += parseDITAChildren(child.children, headingLevel); break;
          case 'thead': html += `<thead>${parseDITAChildren(child.children, headingLevel)}</thead>`; break;
          case 'tbody': html += `<tbody>${parseDITAChildren(child.children, headingLevel)}</tbody>`; break;
          case 'row': html += `<tr>${parseDITAChildren(child.children, headingLevel)}</tr>`; break;
          case 'entry': html += `<td>${escapeHtml(child.textContent)}</td>`; break;
          case 'image': {
            const href = child.getAttribute('href') || '';
            html += `<img src="${escapeAttr(href)}" alt="">`;
            break;
          }
          default:
            html += parseDITAChildren(child.children, headingLevel);
        }
      }
      return html;
    }

    function escapeHtml(s) {
      if (!s && s !== 0) return '';
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }
    function escapeAttr(s) {
      if (!s && s !== 0) return '';
      return String(s).replace(/"/g,'&quot;');
    }

    // Render DITA textarea into quill content
    document.getElementById('loadToEditorBtn').addEventListener('click', () => {
      const xmlText = document.getElementById('ditaTextarea').value.trim();
      if (!xmlText) {
        alert('Paste or generate DITA XML first.');
        return;
      }
      try {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, 'application/xml');
        if (xmlDoc.getElementsByTagName('parsererror').length) {
          alert('Invalid XML. Please check the DITA XML.');
          return;
        }
        const html = transformDITA(xmlDoc);
        // set into quill
        quill.root.innerHTML = html;
      } catch (e) {
        console.error(e);
        alert('Error parsing XML.');
      }
    });

    /*************************************************************************
     * Gemini integration (client-side). WARNING: insecure to put real key here.
     * If you still want quick demo, replace GEMINI_API_KEY above.
     *************************************************************************/
    async function generateXML() {
      const prompt = document.getElementById('promptBox').value.trim();
      if (!prompt) { alert('Enter a prompt first.'); return; }
      if (!GEMINI_API_KEY || GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') {
        // Allow but warn
        if (!confirm('No Gemini API key configured. Do you still want to run a (will fail) request?')) return;
      }
      try {
        const url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=" + encodeURIComponent(GEMINI_API_KEY);
        const body = {
          contents: [{ role: "user", parts: [{ text: `Generate a valid DITA XML topic. Prompt: ${prompt}` }] }]
        };
        const resp = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const json = await resp.json();
        if (json.candidates && json.candidates.length) {
          const generated = json.candidates[0].content.parts[0].text;
          document.getElementById('ditaTextarea').value = generated;
          // auto-render to editor for convenience
          document.getElementById('loadToEditorBtn').click();
        } else {
          alert('No output from Gemini. Check console for response.');
          console.log(json);
        }
      } catch (err) {
        console.error(err);
        alert('Error calling Gemini API (see console).');
      }
    }

    document.getElementById('genBtn').addEventListener('click', generateXML);
    // Enter key on prompt triggers generate
    document.getElementById('promptBox').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); generateXML(); }
    });

    /*************************************************************************
     * Nice UX: when user presses Code Block button (native Quill), keep focus
     *************************************************************************/
    // Quill will manage code-block formatting via toolbar button automatically.

    /*************************************************************************
     * Optional: keyboard shortcuts for table operations can be left to plugin
     *************************************************************************/

    /*************************************************************************
     * Final: initial sample content (optional) to show structure
     *************************************************************************/
    // Pre-fill with a tiny DITA sample
    const sample = `<?xml version="1.0"?>
<topic id="sample">
  <title>Sample DITA Topic</title>
  <p>This is a sample DITA paragraph.</p>
  <note>This is a note.</note>
  <section>
    <title>Section One</title>
    <p>Section content here.</p>
  </section>
  <codeblock>console.log('hello world');</codeblock>
  <table>
    <row><entry>Cell 1</entry><entry>Cell 2</entry></row>
    <row><entry>Cell 3</entry><entry>Cell 4</entry></row>
  </table>
</topic>`;
    document.getElementById('ditaTextarea').value = sample;
    // Render sample automatically to editor
    try {
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(sample, 'application/xml');
      quill.root.innerHTML = transformDITA(xmlDoc);
    } catch (e) { /* ignore */ }

  </script>
</body>
</html>
